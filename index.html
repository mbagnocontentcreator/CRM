<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Consulente Finanziario</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--white);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--primary);
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats {
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: var(--white);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .tab-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: var(--light);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tab-btn:hover {
            background: #e5e7eb;
            transform: translateX(5px);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .content-area {
            background: var(--white);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            min-height: 600px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-box {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            width: 100%;
            margin-bottom: 20px;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .client-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .client-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .client-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.2);
        }

        .client-type {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 5px;
            background: var(--primary);
            color: white;
        }

        .client-type.prospect {
            background: var(--warning);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--danger);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .client-detail {
            display: none;
        }

        .client-detail.active {
            display: block;
        }

        .section {
            margin-top: 30px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .product-type-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .type-fondi { background: #dbeafe; color: #1e40af; }
        .type-azioni { background: #d1fae5; color: #065f46; }
        .type-obbligazioni { background: #fef3c7; color: #92400e; }
        .type-polizze { background: #ede9fe; color: #5b21b6; }
        .type-pip { background: #fee2e2; color: #991b1b; }
        .type-altro { background: #f3f4f6; color: #374151; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--secondary);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            z-index: 10000;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .backup-status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
        }

        .backup-status.ok {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .backup-status.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .backup-status.danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .backup-schedule {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                </svg>
                CRM Consulente Finanziario
            </h1>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalClients">0</div>
                    <div class="stat-label">Clienti Totali</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="activeClients">0</div>
                    <div class="stat-label">Clienti Attivi</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalProspects">0</div>
                    <div class="stat-label">Prospect</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="showTab('clients')">Clienti Attivi</button>
                    <button class="tab-btn" onclick="showTab('prospects')">Prospect</button>
                    <button class="tab-btn" onclick="showTab('all')">Tutti i Contatti</button>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="openAddModal()">
                    + Nuovo Contatto
                </button>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="openImportModal()">
                    📥 Importa da Excel/CSV
                </button>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="exportToExcel()">
                    📤 Esporta in Excel/CSV
                </button>
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px; background: #7c3aed;" onclick="openBackupModal()">
                    🔒 Backup & Sicurezza
                </button>
            </div>

            <div class="content-area">
                <div id="clients-tab" class="tab-content active">
                    <input type="text" class="search-box" placeholder="Cerca clienti..." onkeyup="searchClients(this.value, 'cliente')">
                    <div id="clients-list" class="client-grid"></div>
                </div>

                <div id="prospects-tab" class="tab-content">
                    <input type="text" class="search-box" placeholder="Cerca prospect..." onkeyup="searchClients(this.value, 'prospect')">
                    <div id="prospects-list" class="client-grid"></div>
                </div>

                <div id="all-tab" class="tab-content">
                    <input type="text" class="search-box" placeholder="Cerca contatti..." onkeyup="searchClients(this.value, 'all')">
                    <div id="all-list" class="client-grid"></div>
                </div>

                <div id="client-detail" class="client-detail"></div>
            </div>
        </div>
    </div>

    <!-- Modal Cliente -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nuovo Cliente</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="clientForm" onsubmit="saveClient(event)">
                <div class="form-group">
                    <label>Nominativo Cliente *</label>
                    <input type="text" id="clientName" required>
                </div>
                <div class="form-group">
                    <label>Data di Nascita</label>
                    <input type="date" id="clientBirthDate">
                </div>
                <div class="form-group">
                    <label>Codice Fiscale</label>
                    <input type="text" id="clientCF" maxlength="16" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label>Indirizzo (Via/Viale/Piazza)</label>
                    <input type="text" id="clientAddress" placeholder="Es: Via Roma">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>N. Civico</label>
                        <input type="text" id="clientCivic" placeholder="Es: 15/A">
                    </div>
                    <div class="form-group">
                        <label>Comune</label>
                        <input type="text" id="clientCity" placeholder="Es: Milano">
                    </div>
                    <div class="form-group">
                        <label>CAP</label>
                        <input type="text" id="clientZip" maxlength="5" placeholder="Es: 20100">
                    </div>
                </div>
                <div class="form-group">
                    <label>Provincia</label>
                    <input type="text" id="clientProvince" maxlength="2" style="text-transform: uppercase;" placeholder="Es: MI">
                </div>
                <div class="form-group">
                    <label>Telefono</label>
                    <input type="tel" id="clientPhone">
                </div>
                <div class="form-group">
                    <label>Flusso Telefonico</label>
                    <select id="clientPhoneFlow">
                        <option value="">Non specificato</option>
                        <option value="certificato">Numero Certificato</option>
                        <option value="non_certificato">Numero Non Certificato</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="clientEmail">
                </div>
                <div class="form-group">
                    <label>Servizi Online</label>
                    <select id="clientOnlineServices">
                        <option value="">Non specificato</option>
                        <option value="SI">SI</option>
                        <option value="NO">NO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>My Key</label>
                    <select id="clientMyKey">
                        <option value="NESSUN_MYKEY">Nessun MyKey</option>
                        <option value="MYKEY_SMART">MyKey Smart</option>
                        <option value="MYKEY_SMS">MyKey SMS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Profilo MIFID</label>
                    <select id="clientMIFID">
                        <option value="">Non specificato</option>
                        <option value="Conservativo">Conservativo</option>
                        <option value="Moderato">Moderato</option>
                        <option value="Dinamico">Dinamico</option>
                        <option value="Attivo">Attivo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tipo Cliente</label>
                    <select id="clientType">
                        <option value="cliente">Cliente</option>
                        <option value="prospect">Prospect</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="clientNotes"></textarea>
                </div>
                <div class="form-group">
                    <label>Collegamenti Familiari</label>
                    <select id="familyMembers" multiple style="height: 100px;"></select>
                    <small>Ctrl+Click per selezionare più persone</small>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Prodotto -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nuovo Prodotto Finanziario</h2>
                <button class="close-btn" onclick="closeProductModal()">&times;</button>
            </div>
            <form id="productForm" onsubmit="saveProduct(event)">
                <div class="form-group">
                    <label>Nome Prodotto *</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>Tipo *</label>
                    <select id="productType" required>
                        <option value="">Seleziona...</option>
                        <option value="fondi">Fondi</option>
                        <option value="azioni">Azioni</option>
                        <option value="obbligazioni">Obbligazioni</option>
                        <option value="polizze">Polizze</option>
                        <option value="pip">PIP/Fondi Pensione</option>
                        <option value="altro">Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Valore (€) *</label>
                    <input type="number" id="productValue" step="0.01" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Incontro -->
    <div id="meetingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nuovo Incontro</h2>
                <button class="close-btn" onclick="closeMeetingModal()">&times;</button>
            </div>
            <form id="meetingForm" onsubmit="saveMeeting(event)">
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" id="meetingDate" required>
                </div>
                <div class="form-group">
                    <label>Note *</label>
                    <textarea id="meetingNotes" required></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeMeetingModal()">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Documento -->
    <div id="documentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Carica Documento</h2>
                <button class="close-btn" onclick="closeDocumentModal()">&times;</button>
            </div>
            <form id="documentForm" onsubmit="saveDocument(event)">
                <div class="form-group">
                    <label>File *</label>
                    <input type="file" id="documentFile" required>
                </div>
                <div class="form-group">
                    <label>Descrizione</label>
                    <input type="text" id="documentDesc">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeDocumentModal()">Annulla</button>
                    <button type="submit" class="btn btn-primary">Carica</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Import -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Importa Clienti da Excel/CSV</h2>
                <button class="close-btn" onclick="closeImportModal()">&times;</button>
            </div>
            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">📋 Formato richiesto:</h4>
                <p style="font-size: 14px; color: #666;">Il file deve contenere le seguenti colonne (l'ordine è importante):</p>
                <ol style="font-size: 14px; color: #666; margin-left: 20px;">
                    <li>Nominativo Cliente (obbligatorio)</li>
                    <li>Data di Nascita (formato: GG/MM/AAAA)</li>
                    <li>Codice Fiscale</li>
                    <li>Residenza</li>
                    <li>Telefono</li>
                    <li>Flusso Telefonico (certificato/non_certificato)</li>
                    <li>Email</li>
                    <li>Servizi Online (SI/NO)</li>
                    <li>My Key (MYKEY_SMART/MYKEY_SMS/NESSUN_MYKEY)</li>
                    <li>Profilo MIFID (Conservativo/Moderato/Dinamico/Attivo)</li>
                    <li>Tipo (cliente/prospect)</li>
                    <li>Note</li>
                </ol>
                <button class="btn btn-secondary btn-small" onclick="downloadTemplate()" style="margin-top: 10px;">
                    📄 Scarica Template Excel
                </button>
            </div>
            <form id="importForm" onsubmit="importClients(event)">
                <div class="form-group">
                    <label>Seleziona file Excel o CSV *</label>
                    <input type="file" id="importFile" accept=".csv,.xlsx,.xls" required onchange="previewImport(event)">
                </div>
                <div id="importPreview" style="display: none; margin-top: 20px;">
                    <h4>Anteprima importazione:</h4>
                    <div id="previewContent" style="max-height: 300px; overflow-y: auto; background: #f5f5f5; padding: 10px; border-radius: 8px; font-size: 14px;"></div>
                    <p id="importSummary" style="margin-top: 10px; font-weight: bold;"></p>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeImportModal()">Annulla</button>
                    <button type="submit" class="btn btn-primary" id="importBtn" disabled>Importa</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Backup -->
    <div id="backupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔒 Backup & Sicurezza</h2>
                <button class="close-btn" onclick="closeBackupModal()">&times;</button>
            </div>
            
            <div id="backupStatus" class="backup-status">
                <!-- Status will be updated dynamically -->
            </div>

            <div class="backup-schedule">
                <h3>⏰ Backup Automatico Settimanale</h3>
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="autoBackup" onchange="toggleAutoBackup()" style="width: 20px; height: 20px;">
                        <span>Attiva promemoria backup settimanale</span>
                    </label>
                </div>
                <div id="backupDaySelect" style="display: none; margin-top: 15px;">
                    <label>Giorno della settimana per il backup:</label>
                    <select id="backupDay" onchange="updateBackupDay()" style="width: 100%; padding: 8px; margin-top: 5px;">
                        <option value="1">Lunedì</option>
                        <option value="2">Martedì</option>
                        <option value="3">Mercoledì</option>
                        <option value="4">Giovedì</option>
                        <option value="5">Venerdì</option>
                        <option value="6">Sabato</option>
                        <option value="0">Domenica</option>
                    </select>
                </div>
                <p id="nextBackupInfo" style="margin-top: 15px; color: #666; font-size: 14px;"></p>
            </div>

            <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3>📊 Statistiche Database</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                    <div>
                        <strong>Clienti totali:</strong> <span id="backupTotalClients">0</span>
                    </div>
                    <div>
                        <strong>Prodotti totali:</strong> <span id="backupTotalProducts">0</span>
                    </div>
                    <div>
                        <strong>Documenti totali:</strong> <span id="backupTotalDocs">0</span>
                    </div>
                    <div>
                        <strong>Incontri totali:</strong> <span id="backupTotalMeetings">0</span>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <strong>Ultimo backup:</strong> <span id="lastBackupDate">Mai effettuato</span>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <button class="btn btn-primary" onclick="backupFull()">
                    💾 Backup Completo (JSON)
                </button>
                <button class="btn btn-secondary" onclick="backupExcel()">
                    📊 Backup Excel (CSV)
                </button>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                <h4 style="margin-bottom: 10px;">🔄 Ripristina Backup</h4>
                <p style="font-size: 14px; color: #666; margin-bottom: 10px;">Carica un file di backup JSON precedentemente salvato</p>
                <button class="btn btn-secondary" onclick="restoreBackup()">
                    📂 Carica Backup
                </button>
            </div>
        </div>
    </div>

    <script>
        let clients = [];
        let currentEditId = null;
        let currentClientId = null;

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            renderLists();
            updateStats();
            checkBackupReminder();
        });

        // Tabs
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Modal
        function openAddModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Nuovo Cliente';
            document.getElementById('clientForm').reset();
            document.getElementById('clientMyKey').value = 'NESSUN_MYKEY';
            updateFamilySelect();
            document.getElementById('clientModal').style.display = 'block';
        }

        function openEditModal(id) {
            currentEditId = id;
            const client = clients.find(c => c.id === id);
            document.getElementById('modalTitle').textContent = 'Modifica Cliente';
            document.getElementById('clientName').value = client.name;
            document.getElementById('clientBirthDate').value = client.birthDate || '';
            document.getElementById('clientCF').value = client.cf || '';
            document.getElementById('clientAddress').value = client.address || '';
            document.getElementById('clientCivic').value = client.civic || '';
            document.getElementById('clientCity').value = client.city || '';
            document.getElementById('clientZip').value = client.zip || '';
            document.getElementById('clientProvince').value = client.province || '';
            document.getElementById('clientPhone').value = client.phone || '';
            document.getElementById('clientPhoneFlow').value = client.phoneFlow || '';
            document.getElementById('clientEmail').value = client.email || '';
            document.getElementById('clientOnlineServices').value = client.onlineServices || '';
            document.getElementById('clientMyKey').value = client.myKey || 'NESSUN_MYKEY';
            document.getElementById('clientMIFID').value = client.mifid || '';
            document.getElementById('clientType').value = client.type;
            document.getElementById('clientNotes').value = client.notes || '';
            updateFamilySelect();
            if (client.familyMembers) {
                const select = document.getElementById('familyMembers');
                Array.from(select.options).forEach(opt => {
                    opt.selected = client.familyMembers.includes(opt.value);
                });
            }
            document.getElementById('clientModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('clientModal').style.display = 'none';
        }

        function updateFamilySelect() {
            const select = document.getElementById('familyMembers');
            select.innerHTML = clients
                .filter(c => !currentEditId || c.id !== currentEditId)
                .map(c => `<option value="${c.id}">${c.name}</option>`)
                .join('');
        }

        // Save Client
        function saveClient(event) {
            event.preventDefault();
            
            const data = {
                name: document.getElementById('clientName').value,
                birthDate: document.getElementById('clientBirthDate').value,
                cf: document.getElementById('clientCF').value.toUpperCase(),
                address: document.getElementById('clientAddress').value,
                civic: document.getElementById('clientCivic').value,
                city: document.getElementById('clientCity').value,
                zip: document.getElementById('clientZip').value,
                province: document.getElementById('clientProvince').value.toUpperCase(),
                phone: document.getElementById('clientPhone').value,
                phoneFlow: document.getElementById('clientPhoneFlow').value,
                email: document.getElementById('clientEmail').value,
                onlineServices: document.getElementById('clientOnlineServices').value,
                myKey: document.getElementById('clientMyKey').value,
                mifid: document.getElementById('clientMIFID').value,
                type: document.getElementById('clientType').value,
                notes: document.getElementById('clientNotes').value,
                familyMembers: Array.from(document.getElementById('familyMembers').selectedOptions).map(o => o.value)
            };
            
            if (currentEditId) {
                const index = clients.findIndex(c => c.id === currentEditId);
                clients[index] = { ...clients[index], ...data };
            } else {
                data.id = Date.now().toString();
                data.createdAt = new Date().toISOString();
                data.products = [];
                data.meetings = [];
                data.documents = [];
                clients.push(data);
            }
            
            saveData();
            renderLists();
            updateStats();
            closeModal();
            showNotification('Cliente salvato!');
        }

        function deleteClient(id) {
            if (confirm('Eliminare questo cliente?')) {
                clients = clients.filter(c => c.id !== id);
                saveData();
                renderLists();
                updateStats();
            }
        }

        // Show Client Detail
        function showClientDetail(id) {
            currentClientId = id;
            const client = clients.find(c => c.id === id);
            
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('client-detail').classList.add('active');
            
            const familyHtml = client.familyMembers && client.familyMembers.length > 0
                ? client.familyMembers.map(fId => {
                    const member = clients.find(c => c.id === fId);
                    return member ? `<span style="display: inline-block; padding: 5px 10px; background: var(--primary); color: white; border-radius: 15px; margin: 2px; cursor: pointer;" onclick="showClientDetail('${fId}')">${member.name}</span>` : '';
                }).join('')
                : '<span style="color: #999;">Nessun collegamento</span>';
            
            // Calculate age if birthDate exists
            const age = client.birthDate ? 
                Math.floor((new Date() - new Date(client.birthDate)) / (365.25 * 24 * 60 * 60 * 1000)) : null;
            
            document.getElementById('client-detail').innerHTML = `
                <div style="margin-bottom: 30px;">
                    <button class="btn btn-secondary" onclick="backToList()">← Torna alla lista</button>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h2 style="display: inline-block; margin-right: 10px;">${client.name}</h2>
                    <span class="client-type ${client.type === 'prospect' ? 'prospect' : ''}">${client.type}</span>
                    <button class="btn btn-primary btn-small" style="float: right;" onclick="openEditModal('${client.id}')">Modifica</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f9fafb; padding: 20px; border-radius: 10px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Dati Anagrafici</h4>
                        ${client.birthDate ? `<p><strong>Data di Nascita:</strong> ${new Date(client.birthDate).toLocaleDateString('it-IT')} (${age} anni)</p>` : ''}
                        ${client.cf ? `<p><strong>Codice Fiscale:</strong> ${client.cf}</p>` : ''}
                        ${(client.address || client.city) ? `
                            <div style="margin-top: 10px;">
                                <p><strong>Indirizzo:</strong></p>
                                <p style="margin-left: 10px;">${[
                                    client.address,
                                    client.civic,
                                    client.zip,
                                    client.city,
                                    client.province ? `(${client.province})` : ''
                                ].filter(Boolean).join(' ')}</p>
                                ${client.address && client.city ? `
                                    <button class="btn btn-secondary btn-small" style="margin-top: 10px;" onclick="openGoogleMaps('${client.id}')">
                                        📍 Apri in Google Maps
                                    </button>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="background: #f9fafb; padding: 20px; border-radius: 10px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Contatti</h4>
                        ${client.phone ? `
                            <div style="margin-bottom: 10px;">
                                <p><strong>Telefono:</strong> ${client.phone} 
                                ${client.phoneFlow ? `<span style="background: ${client.phoneFlow === 'certificato' ? '#10b981' : '#f59e0b'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">${client.phoneFlow === 'certificato' ? '✓ Certificato' : '⚠ Non Certificato'}</span>` : ''}</p>
                                <button class="btn btn-secondary btn-small" style="margin-top: 8px; background: #25D366;" onclick="openWhatsApp('${client.phone}')">
                                    <span style="font-size: 16px;">📱</span> WhatsApp
                                </button>
                            </div>
                        ` : ''}
                        ${client.email ? `
                            <div>
                                <p><strong>Email:</strong> ${client.email}</p>
                                <button class="btn btn-secondary btn-small" style="margin-top: 8px; background: #EA4335;" onclick="sendEmail('${client.email}', '${client.name}')">
                                    <span style="font-size: 16px;">📧</span> Invia Email
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="background: #f9fafb; padding: 20px; border-radius: 10px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Servizi Digitali</h4>
                        <p><strong>Servizi Online:</strong> ${client.onlineServices ? 
                            `<span style="background: ${client.onlineServices === 'SI' ? '#10b981' : '#ef4444'}; color: white; padding: 2px 12px; border-radius: 12px;">${client.onlineServices}</span>` : 
                            '<span style="color: #999;">Non specificato</span>'}</p>
                        <p><strong>My Key:</strong> <span style="background: ${client.myKey === 'MYKEY_SMART' ? '#3b82f6' : client.myKey === 'MYKEY_SMS' ? '#8b5cf6' : '#6b7280'}; color: white; padding: 2px 12px; border-radius: 12px; font-size: 14px;">${client.myKey ? client.myKey.replace(/_/g, ' ') : 'NESSUN MYKEY'}</span></p>
                    </div>
                    
                    <div style="background: #f9fafb; padding: 20px; border-radius: 10px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Profilo Finanziario</h4>
                        ${client.mifid ? `<p><strong>Profilo MIFID:</strong> <span style="background: ${
                            client.mifid === 'Conservativo' ? '#10b981' : 
                            client.mifid === 'Moderato' ? '#3b82f6' : 
                            client.mifid === 'Dinamico' ? '#f59e0b' : 
                            client.mifid === 'Attivo' ? '#ef4444' : '#6b7280'
                        }; color: white; padding: 4px 16px; border-radius: 20px; font-weight: 500;">${client.mifid}</span></p>` : '<p style="color: #999;">Profilo MIFID non specificato</p>'}
                    </div>
                </div>
                
                ${client.notes ? `
                    <div style="background: #fef3c7; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #92400e; margin-bottom: 10px;">📝 Note</h4>
                        <p style="color: #92400e;">${client.notes}</p>
                    </div>
                ` : ''}
                
                <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #1e40af; margin-bottom: 10px;">👨‍👩‍👧‍👦 Collegamenti Familiari</h4>
                    ${familyHtml}
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h3>Documenti</h3>
                        <button class="btn btn-primary btn-small" onclick="openDocumentModal()">+ Documento</button>
                    </div>
                    <div id="documents-list">
                        ${renderDocuments(client)}
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h3>Prodotti Finanziari</h3>
                        <button class="btn btn-primary btn-small" onclick="openProductModal()">+ Prodotto</button>
                    </div>
                    <div id="products-list">
                        ${renderProducts(client)}
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h3>Incontri</h3>
                        <button class="btn btn-primary btn-small" onclick="openMeetingModal()">+ Incontro</button>
                    </div>
                    <div id="meetings-list">
                        ${renderMeetings(client)}
                    </div>
                </div>
            `;
        }

        function backToList() {
            document.getElementById('client-detail').classList.remove('active');
            document.getElementById('clients-tab').classList.add('active');
            document.querySelector('.tab-btn').classList.add('active');
        }

        // Products
        function openProductModal() {
            document.getElementById('productForm').reset();
            document.getElementById('productModal').style.display = 'block';
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        function saveProduct(event) {
            event.preventDefault();
            const client = clients.find(c => c.id === currentClientId);
            if (!client.products) client.products = [];
            client.products.push({
                id: Date.now().toString(),
                name: document.getElementById('productName').value,
                type: document.getElementById('productType').value,
                value: parseFloat(document.getElementById('productValue').value)
            });
            saveData();
            showClientDetail(currentClientId);
            closeProductModal();
            showNotification('Prodotto aggiunto!');
        }

        function deleteProduct(productId) {
            const client = clients.find(c => c.id === currentClientId);
            client.products = client.products.filter(p => p.id !== productId);
            saveData();
            showClientDetail(currentClientId);
        }

        function renderProducts(client) {
            if (!client.products || client.products.length === 0) {
                return '<p style="color: #999; text-align: center;">Nessun prodotto</p>';
            }
            const total = client.products.reduce((sum, p) => sum + p.value, 0);
            return `
                <div style="background: #e0e7ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>Valore Totale Portfolio: € ${total.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong>
                </div>
                ${client.products.map(p => `
                    <div style="margin: 10px 0; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${p.name}</strong>
                                <span class="product-type-badge type-${p.type}" style="margin-left: 10px;">${p.type}</span>
                                <div style="margin-top: 5px; color: #666;">€ ${p.value.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                            </div>
                            <button class="btn btn-danger btn-small" onclick="deleteProduct('${p.id}')">Elimina</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // Meetings
        function openMeetingModal() {
            document.getElementById('meetingForm').reset();
            document.getElementById('meetingDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('meetingModal').style.display = 'block';
        }

        function closeMeetingModal() {
            document.getElementById('meetingModal').style.display = 'none';
        }

        function saveMeeting(event) {
            event.preventDefault();
            const client = clients.find(c => c.id === currentClientId);
            if (!client.meetings) client.meetings = [];
            client.meetings.push({
                id: Date.now().toString(),
                date: document.getElementById('meetingDate').value,
                notes: document.getElementById('meetingNotes').value
            });
            saveData();
            showClientDetail(currentClientId);
            closeMeetingModal();
            showNotification('Incontro aggiunto!');
        }

        function deleteMeeting(meetingId) {
            const client = clients.find(c => c.id === currentClientId);
            client.meetings = client.meetings.filter(m => m.id !== meetingId);
            saveData();
            showClientDetail(currentClientId);
        }

        function renderMeetings(client) {
            if (!client.meetings || client.meetings.length === 0) {
                return '<p style="color: #999; text-align: center;">Nessun incontro</p>';
            }
            return client.meetings
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(m => `
                    <div style="margin: 10px 0; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong style="color: var(--primary);">${new Date(m.date).toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</strong>
                                <div style="margin-top: 5px; color: #666;">${m.notes}</div>
                            </div>
                            <button class="btn btn-danger btn-small" onclick="deleteMeeting('${m.id}')">Elimina</button>
                        </div>
                    </div>
                `).join('');
        }

        // Documents
        function openDocumentModal() {
            document.getElementById('documentForm').reset();
            document.getElementById('documentModal').style.display = 'block';
        }

        function closeDocumentModal() {
            document.getElementById('documentModal').style.display = 'none';
        }

        function saveDocument(event) {
            event.preventDefault();
            const file = document.getElementById('documentFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const client = clients.find(c => c.id === currentClientId);
                if (!client.documents) client.documents = [];
                client.documents.push({
                    id: Date.now().toString(),
                    name: file.name,
                    desc: document.getElementById('documentDesc').value || 'Documento',
                    data: e.target.result,
                    size: file.size,
                    type: file.type,
                    date: new Date().toISOString()
                });
                saveData();
                showClientDetail(currentClientId);
                closeDocumentModal();
                showNotification('Documento caricato!');
            };
            reader.readAsDataURL(file);
        }

        function deleteDocument(docId) {
            const client = clients.find(c => c.id === currentClientId);
            client.documents = client.documents.filter(d => d.id !== docId);
            saveData();
            showClientDetail(currentClientId);
        }

        function downloadDocument(docId) {
            const client = clients.find(c => c.id === currentClientId);
            const doc = client.documents.find(d => d.id === docId);
            const link = document.createElement('a');
            link.href = doc.data;
            link.download = doc.name;
            link.click();
        }

        function renderDocuments(client) {
            if (!client.documents || client.documents.length === 0) {
                return '<p style="color: #999; text-align: center;">Nessun documento</p>';
            }
            return client.documents.map(d => `
                <div style="margin: 10px 0; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${d.name}</strong>
                            <div style="margin-top: 5px; color: #666;">${d.desc} • ${formatFileSize(d.size)} • ${new Date(d.date).toLocaleDateString('it-IT')}</div>
                        </div>
                        <div>
                            <button class="btn btn-secondary btn-small" onclick="downloadDocument('${d.id}')">Scarica</button>
                            <button class="btn btn-danger btn-small" onclick="deleteDocument('${d.id}')">Elimina</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Search
        function searchClients(term, type) {
            const filtered = clients.filter(c => {
                const matches = c.name.toLowerCase().includes(term.toLowerCase()) ||
                              (c.email && c.email.toLowerCase().includes(term.toLowerCase())) ||
                              (c.phone && c.phone.includes(term)) ||
                              (c.cf && c.cf.toLowerCase().includes(term.toLowerCase()));
                if (type === 'all') return matches;
                return matches && c.type === type;
            });
            
            if (type === 'cliente') {
                renderClientsList(filtered.filter(c => c.type === 'cliente'), 'clients-list');
            } else if (type === 'prospect') {
                renderClientsList(filtered.filter(c => c.type === 'prospect'), 'prospects-list');
            } else {
                renderClientsList(filtered, 'all-list');
            }
        }

        // Google Maps integration
        function openGoogleMaps(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client && client.address && client.city) {
                const fullAddress = [
                    client.address,
                    client.civic,
                    client.zip,
                    client.city,
                    client.province
                ].filter(Boolean).join(' ');
                
                const encodedAddress = encodeURIComponent(fullAddress);
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodedAddress}`, '_blank');
            }
        }

        // WhatsApp integration
        function openWhatsApp(phone) {
            if (phone) {
                // Remove spaces, dashes, and other non-numeric characters
                let cleanPhone = phone.replace(/[^0-9+]/g, '');
                
                // If the number doesn't start with +, assume it's Italian
                if (!cleanPhone.startsWith('+')) {
                    cleanPhone = '+39' + cleanPhone;
                }
                
                // Open WhatsApp with the phone number
                window.open(`https://wa.me/${cleanPhone}`, '_blank');
            }
        }

        // Email integration
        function sendEmail(email, clientName) {
            if (email) {
                // Create email with pre-filled subject
                const subject = encodeURIComponent(`Comunicazione per ${clientName}`);
                const body = encodeURIComponent(`Gentile ${clientName},\n\n`);
                
                // Open default email client
                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
            }
        }

        // Render
        function renderLists() {
            renderClientsList(clients.filter(c => c.type === 'cliente'), 'clients-list');
            renderClientsList(clients.filter(c => c.type === 'prospect'), 'prospects-list');
            renderClientsList(clients, 'all-list');
        }

        function renderClientsList(list, containerId) {
            const container = document.getElementById(containerId);
            if (list.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Nessun contatto</p></div>';
                return;
            }
            
            container.innerHTML = list.map(client => {
                const totalValue = client.products ? client.products.reduce((sum, p) => sum + p.value, 0) : 0;
                return `
                    <div class="client-card" onclick="showClientDetail('${client.id}')">
                        <h3>${client.name} <span class="client-type ${client.type === 'prospect' ? 'prospect' : ''}">${client.type}</span></h3>
                        ${client.cf ? `<p style="font-size: 12px; color: #666;">CF: ${client.cf}</p>` : ''}
                        ${(client.city || client.province) ? `<p style="font-size: 14px; color: #666;">📍 ${[client.city, client.province].filter(Boolean).join(' - ')}</p>` : ''}
                        ${client.phone ? `<p>📱 ${client.phone} ${client.phoneFlow === 'certificato' ? '✓' : ''}</p>` : ''}
                        ${client.email ? `<p>📧 ${client.email}</p>` : ''}
                        ${client.onlineServices ? `<p>🌐 Servizi Online: ${client.onlineServices}</p>` : ''}
                        ${client.products && client.products.length > 0 ? `<p>💼 ${client.products.length} prodotti (€ ${totalValue.toLocaleString('it-IT', {minimumFractionDigits: 2})})</p>` : ''}
                        ${client.meetings && client.meetings.length > 0 ? `<p>📅 ${client.meetings.length} incontri</p>` : ''}
                        ${client.documents && client.documents.length > 0 ? `<p>📄 ${client.documents.length} documenti</p>` : ''}
                        <div style="margin-top: 10px;" onclick="event.stopPropagation()">
                            <button class="btn btn-primary btn-small" onclick="openEditModal('${client.id}')">Modifica</button>
                            <button class="btn btn-danger btn-small" onclick="deleteClient('${client.id}')">Elimina</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Stats
        function updateStats() {
            document.getElementById('totalClients').textContent = clients.length;
            document.getElementById('activeClients').textContent = clients.filter(c => c.type === 'cliente').length;
            document.getElementById('totalProspects').textContent = clients.filter(c => c.type === 'prospect').length;
        }

        // Notification
        function showNotification(message) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.classList.add('show'), 100);
            setTimeout(() => {
                notif.classList.remove('show');
                setTimeout(() => document.body.removeChild(notif), 300);
            }, 3000);
        }

        // Storage
        function saveData() {
            localStorage.setItem('crmClients', JSON.stringify(clients));
        }

        function loadData() {
            const saved = localStorage.getItem('crmClients');
            if (saved) {
                clients = JSON.parse(saved);
            }
        }

        // Import/Export Functions
        function openImportModal() {
            document.getElementById('importForm').reset();
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importBtn').disabled = true;
            document.getElementById('importModal').style.display = 'block';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }

        function downloadTemplate() {
            const template = '"Nominativo Cliente","Data di Nascita","Codice Fiscale","Residenza","Telefono","Flusso Telefonico","Email","Servizi Online","My Key","Profilo MIFID","Tipo","Note"\n' +
                           '"Mario Rossi","15/03/1970","RSSMRA70C15H501X","Via Roma, 1 Milano","333-1234567","certificato","mario.rossi@email.com","SI","MYKEY_SMART","Moderato","cliente","Cliente importante"\n' +
                           '"Luigi Bianchi","22/07/1985","BNCLGU85L22F205Y","Via Milano, 2 Roma","335-9876543","non_certificato","luigi.bianchi@email.com","NO","NESSUN_MYKEY","Dinamico","prospect","Potenziale cliente"\n';
            
            const blob = new Blob(['\ufeff' + template], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'template_importazione_clienti.csv';
            link.click();
        }

        let importData = [];

        // Helper function to convert date format
        function convertDateFormat(dateStr) {
            if (!dateStr) return '';
            // Convert from DD/MM/YYYY to YYYY-MM-DD
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            return dateStr;
        }

        function previewImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Mostra indicatore di caricamento
            const preview = document.getElementById('previewContent');
            preview.innerHTML = '<div style="text-align: center; padding: 20px;"><strong>Caricamento in corso...</strong><br><small>Attendere prego...</small></div>';
            document.getElementById('importPreview').style.display = 'block';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    let data = [];

                    if (file.name.endsWith('.csv')) {
                        // Parse CSV con gestione migliore delle virgole
                        const lines = text.split(/\r?\n/).filter(line => line.trim());
                        
                        // Funzione per split CSV che gestisce le virgole dentro le virgolette
                        function parseCSVLine(line) {
                            const result = [];
                            let current = '';
                            let inQuotes = false;
                            
                            for (let i = 0; i < line.length; i++) {
                                const char = line[i];
                                
                                if (char === '"') {
                                    inQuotes = !inQuotes;
                                } else if (char === ',' && !inQuotes) {
                                    result.push(current.trim());
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }
                            result.push(current.trim());
                            
                            return result;
                        }
                        
                        // Salta l'header
                        for (let i = 1; i < lines.length; i++) {
                            const values = parseCSVLine(lines[i]);
                            if (values[0]) { // Check if name exists
                                data.push({
                                    name: values[0] || '',
                                    birthDate: convertDateFormat(values[1]) || '',
                                    cf: (values[2] || '').toUpperCase(),
                                    address: values[3] || '',
                                    phone: values[4] || '',
                                    phoneFlow: values[5] || '',
                                    email: values[6] || '',
                                    onlineServices: values[7] || '',
                                    myKey: values[8] || 'NESSUN_MYKEY',
                                    mifid: values[9] || '',
                                    type: values[10] || 'cliente',
                                    notes: values[11] || ''
                                });
                            }
                        }
                    } else {
                        throw new Error('Formato file non supportato. Usa file CSV.');
                    }

                    importData = data;
                    displayPreview(data);
                } catch (error) {
                    preview.innerHTML = `<div style="color: red; padding: 20px;">
                        <strong>Errore durante il caricamento:</strong><br>
                        ${error.message}<br><br>
                        <small>Verifica che il file sia in formato CSV e che rispetti il template.</small>
                    </div>`;
                    document.getElementById('importBtn').disabled = true;
                }
            };

            reader.onerror = function() {
                preview.innerHTML = '<div style="color: red; padding: 20px;">Errore nella lettura del file. Riprova.</div>';
                document.getElementById('importBtn').disabled = true;
            };

            reader.readAsText(file, 'UTF-8');
        }

        function displayPreview(data) {
            const preview = document.getElementById('previewContent');
            const summary = document.getElementById('importSummary');
            
            if (data.length === 0) {
                preview.innerHTML = '<p style="color: red;">Nessun dato valido trovato nel file</p>';
                document.getElementById('importBtn').disabled = true;
                return;
            }

            // Show first 5 records as preview
            const previewHtml = data.slice(0, 5).map((row, index) => `
                <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px;">
                    <strong>${index + 1}. ${row.name}</strong> (${row.type})<br>
                    ${row.cf ? `CF: ${row.cf}<br>` : ''}
                    ${row.phone ? `Tel: ${row.phone} (${row.phoneFlow || 'non specificato'})<br>` : ''}
                    ${row.email ? `Email: ${row.email}<br>` : ''}
                    ${row.onlineServices ? `Servizi Online: ${row.onlineServices}<br>` : ''}
                    ${row.myKey ? `MyKey: ${row.myKey}<br>` : ''}
                    ${row.mifid ? `MIFID: ${row.mifid}` : ''}
                </div>
            `).join('');

            preview.innerHTML = previewHtml + (data.length > 5 ? `<p>... e altri ${data.length - 5} record</p>` : '');
            summary.textContent = `Totale record da importare: ${data.length}`;
            
            document.getElementById('importPreview').style.display = 'block';
            document.getElementById('importBtn').disabled = false;
        }

        function importClients(event) {
            event.preventDefault();
            
            if (importData.length === 0) {
                alert('Nessun dato da importare');
                return;
            }

            // Disabilita il pulsante e mostra stato
            const importBtn = document.getElementById('importBtn');
            const originalText = importBtn.innerHTML;
            importBtn.disabled = true;
            importBtn.innerHTML = '⏳ Importazione in corso...';

            // Usa setTimeout per permettere all'UI di aggiornarsi
            setTimeout(() => {
                try {
                    let imported = 0;
                    let skipped = 0;
                    let errors = [];

                    importData.forEach((row, index) => {
                        try {
                            // Validazione base
                            if (!row.name || row.name.trim() === '') {
                                errors.push(`Riga ${index + 2}: Nome mancante`);
                                return;
                            }

                            // Check if client already exists by name and CF
                            const exists = clients.some(c => 
                                c.name.toLowerCase() === row.name.toLowerCase() || 
                                (row.cf && c.cf && c.cf.toLowerCase() === row.cf.toLowerCase())
                            );
                            
                            if (!exists) {
                                // Validazione e normalizzazione dati
                                const newClient = {
                                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                                    name: row.name.trim(),
                                    birthDate: row.birthDate || '',
                                    cf: row.cf ? row.cf.toUpperCase().trim() : '',
                                    address: row.address || '',
                                    civic: '',
                                    city: '',
                                    zip: '',
                                    province: '',
                                    phone: row.phone || '',
                                    phoneFlow: ['certificato', 'non_certificato'].includes(row.phoneFlow) ? row.phoneFlow : '',
                                    email: row.email || '',
                                    onlineServices: ['SI', 'NO'].includes(row.onlineServices) ? row.onlineServices : '',
                                    myKey: ['MYKEY_SMART', 'MYKEY_SMS', 'NESSUN_MYKEY'].includes(row.myKey) ? row.myKey : 'NESSUN_MYKEY',
                                    mifid: ['Conservativo', 'Moderato', 'Dinamico', 'Attivo'].includes(row.mifid) ? row.mifid : '',
                                    type: ['cliente', 'prospect'].includes(row.type) ? row.type : 'cliente',
                                    notes: row.notes || '',
                                    createdAt: new Date().toISOString(),
                                    products: [],
                                    meetings: [],
                                    documents: [],
                                    familyMembers: []
                                };
                                
                                clients.push(newClient);
                                imported++;
                            } else {
                                skipped++;
                            }
                        } catch (rowError) {
                            errors.push(`Riga ${index + 2}: ${rowError.message}`);
                        }
                    });

                    // Salva e aggiorna
                    saveData();
                    renderLists();
                    updateStats();
                    
                    // Ripristina il pulsante
                    importBtn.disabled = false;
                    importBtn.innerHTML = originalText;
                    
                    // Chiudi modal e mostra risultato
                    closeImportModal();
                    
                    // Messaggio di riepilogo
                    let message = `✅ Importazione completata!\n\n`;
                    message += `• ${imported} clienti importati con successo\n`;
                    if (skipped > 0) {
                        message += `• ${skipped} clienti saltati (già esistenti)\n`;
                    }
                    if (errors.length > 0) {
                        message += `\n⚠️ Errori riscontrati:\n${errors.slice(0, 5).join('\n')}`;
                        if (errors.length > 5) {
                            message += `\n... e altri ${errors.length - 5} errori`;
                        }
                    }
                    
                    alert(message);
                    
                } catch (error) {
                    // Ripristina il pulsante in caso di errore
                    importBtn.disabled = false;
                    importBtn.innerHTML = originalText;
                    
                    alert('Errore durante l\'importazione: ' + error.message);
                }
            }, 100);
        }

        // Export to Excel
        function exportToExcel() {
            let csv = '\ufeff'; // UTF-8 BOM for Excel
            csv += 'Nominativo Cliente,Data di Nascita,Codice Fiscale,Indirizzo,Numero Civico,Comune,CAP,Provincia,Telefono,Flusso Telefonico,Email,Servizi Online,My Key,Profilo MIFID,Tipo,Note,Numero Prodotti,Valore Portfolio,Numero Incontri,Numero Documenti\n';
            
            clients.forEach(client => {
                const totalValue = client.products ? client.products.reduce((sum, p) => sum + p.value, 0) : 0;
                const birthDateFormatted = client.birthDate ? 
                    new Date(client.birthDate).toLocaleDateString('it-IT') : '';
                
                const row = [
                    client.name,
                    birthDateFormatted,
                    client.cf || '',
                    client.address || '',
                    client.civic || '',
                    client.city || '',
                    client.zip || '',
                    client.province || '',
                    client.phone || '',
                    client.phoneFlow || '',
                    client.email || '',
                    client.onlineServices || '',
                    client.myKey || '',
                    client.mifid || '',
                    client.type,
                    client.notes ? client.notes.replace(/,/g, ';') : '',
                    client.products ? client.products.length : 0,
                    totalValue,
                    client.meetings ? client.meetings.length : 0,
                    client.documents ? client.documents.length : 0
                ].join(',');
                csv += row + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'esportazione_crm_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            
            showNotification('Esportazione completata!');
        }

        // Backup Functions
        function openBackupModal() {
            updateBackupStatus();
            updateBackupStats();
            loadBackupSettings();
            document.getElementById('backupModal').style.display = 'block';
        }

        function closeBackupModal() {
            document.getElementById('backupModal').style.display = 'none';
        }

        function updateBackupStatus() {
            const lastBackup = localStorage.getItem('lastBackupDate');
            const statusDiv = document.getElementById('backupStatus');
            
            if (!lastBackup) {
                statusDiv.className = 'backup-status danger';
                statusDiv.innerHTML = '⚠️ <strong>Attenzione!</strong> Non hai mai effettuato un backup';
            } else {
                const lastBackupDate = new Date(lastBackup);
                const daysSinceBackup = Math.floor((new Date() - lastBackupDate) / (1000 * 60 * 60 * 24));
                
                if (daysSinceBackup === 0) {
                    statusDiv.className = 'backup-status ok';
                    statusDiv.innerHTML = '✅ <strong>Backup aggiornato</strong> - Effettuato oggi';
                } else if (daysSinceBackup <= 7) {
                    statusDiv.className = 'backup-status ok';
                    statusDiv.innerHTML = `✅ <strong>Backup recente</strong> - ${daysSinceBackup} giorni fa`;
                } else if (daysSinceBackup <= 14) {
                    statusDiv.className = 'backup-status warning';
                    statusDiv.innerHTML = `⚠️ <strong>Backup da aggiornare</strong> - ${daysSinceBackup} giorni fa`;
                } else {
                    statusDiv.className = 'backup-status danger';
                    statusDiv.innerHTML = `❌ <strong>Backup obsoleto!</strong> - ${daysSinceBackup} giorni fa`;
                }
            }
            
            document.getElementById('lastBackupDate').textContent = lastBackup ? 
                new Date(lastBackup).toLocaleDateString('it-IT', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Mai effettuato';
        }

        function updateBackupStats() {
            let totalProducts = 0;
            let totalDocs = 0;
            let totalMeetings = 0;
            
            clients.forEach(client => {
                totalProducts += (client.products || []).length;
                totalDocs += (client.documents || []).length;
                totalMeetings += (client.meetings || []).length;
            });
            
            document.getElementById('backupTotalClients').textContent = clients.length;
            document.getElementById('backupTotalProducts').textContent = totalProducts;
            document.getElementById('backupTotalDocs').textContent = totalDocs;
            document.getElementById('backupTotalMeetings').textContent = totalMeetings;
        }

        function toggleAutoBackup() {
            const enabled = document.getElementById('autoBackup').checked;
            document.getElementById('backupDaySelect').style.display = enabled ? 'block' : 'none';
            
            if (enabled) {
                localStorage.setItem('autoBackupEnabled', 'true');
                const backupDay = document.getElementById('backupDay').value;
                localStorage.setItem('backupDay', backupDay);
                updateNextBackupInfo();
            } else {
                localStorage.removeItem('autoBackupEnabled');
                localStorage.removeItem('backupDay');
                document.getElementById('nextBackupInfo').textContent = '';
            }
        }

        function updateBackupDay() {
            const backupDay = document.getElementById('backupDay').value;
            localStorage.setItem('backupDay', backupDay);
            updateNextBackupInfo();
        }

        function updateNextBackupInfo() {
            const backupDay = parseInt(document.getElementById('backupDay').value);
            const today = new Date();
            const currentDay = today.getDay();
            let daysUntilBackup = backupDay - currentDay;
            
            if (daysUntilBackup <= 0) {
                daysUntilBackup += 7;
            }
            
            const nextBackup = new Date();
            nextBackup.setDate(today.getDate() + daysUntilBackup);
            
            document.getElementById('nextBackupInfo').textContent = 
                `Prossimo promemoria: ${nextBackup.toLocaleDateString('it-IT', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long' 
                })}`;
        }

        function loadBackupSettings() {
            const autoBackupEnabled = localStorage.getItem('autoBackupEnabled') === 'true';
            const backupDay = localStorage.getItem('backupDay') || '5'; // Default Friday
            
            document.getElementById('autoBackup').checked = autoBackupEnabled;
            document.getElementById('backupDay').value = backupDay;
            document.getElementById('backupDaySelect').style.display = autoBackupEnabled ? 'block' : 'none';
            
            if (autoBackupEnabled) {
                updateNextBackupInfo();
            }
        }

        function checkBackupReminder() {
            const autoBackupEnabled = localStorage.getItem('autoBackupEnabled') === 'true';
            if (!autoBackupEnabled) return;
            
            const lastBackup = localStorage.getItem('lastBackupDate');
            const backupDay = parseInt(localStorage.getItem('backupDay') || '5');
            const today = new Date();
            
            // Check if today is the backup day
            if (today.getDay() === backupDay) {
                const lastReminderDate = localStorage.getItem('lastReminderDate');
                const todayStr = today.toDateString();
                
                // Show reminder only once per day
                if (lastReminderDate !== todayStr) {
                    localStorage.setItem('lastReminderDate', todayStr);
                    
                    if (!lastBackup || (new Date() - new Date(lastBackup)) > 7 * 24 * 60 * 60 * 1000) {
                        setTimeout(() => {
                            if (confirm('🔔 Promemoria Backup Settimanale!\n\nÈ il giorno programmato per il backup. Vuoi effettuarlo ora?')) {
                                openBackupModal();
                            }
                        }, 2000);
                    }
                }
            }
        }

        function backupFull() {
            const backupData = {
                version: '2.0',
                date: new Date().toISOString(),
                clients: clients,
                settings: {
                    autoBackupEnabled: localStorage.getItem('autoBackupEnabled'),
                    backupDay: localStorage.getItem('backupDay')
                }
            };
            
            const json = JSON.stringify(backupData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup_crm_completo_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            localStorage.setItem('lastBackupDate', new Date().toISOString());
            updateBackupStatus();
            showNotification('✅ Backup completo salvato con successo!');
        }

        function backupExcel() {
            exportToExcel();
            localStorage.setItem('lastBackupDate', new Date().toISOString());
            updateBackupStatus();
        }

        function restoreBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.clients && Array.isArray(data.clients)) {
                            if (confirm('⚠️ ATTENZIONE!\n\nQuesto sostituirà TUTTI i dati attuali con quelli del backup.\n\nSei sicuro di voler procedere?')) {
                                clients = data.clients;
                                saveData();
                                renderLists();
                                updateStats();
                                showNotification('✅ Backup ripristinato con successo!');
                                closeBackupModal();
                            }
                        } else {
                            alert('File di backup non valido');
                        }
                    } catch (error) {
                        alert('Errore nel caricamento del backup: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>