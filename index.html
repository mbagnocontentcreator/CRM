<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Consulente Finanziario</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--white);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--primary);
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats {
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: var(--white);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .tab-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: var(--light);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tab-btn:hover {
            background: #e5e7eb;
            transform: translateX(5px);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .content-area {
            background: var(--white);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            min-height: 600px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-box {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            width: 100%;
            margin-bottom: 20px;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .client-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .client-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .client-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.2);
        }

        .client-type {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 5px;
            background: var(--primary);
            color: white;
        }

        .client-type.prospect {
            background: var(--warning);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--danger);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .client-detail {
            display: none;
        }

        .client-detail.active {
            display: block;
        }

        .section {
            margin-top: 30px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .product-type-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .type-fondi { background: #dbeafe; color: #1e40af; }
        .type-azioni { background: #d1fae5; color: #065f46; }
        .type-obbligazioni { background: #fef3c7; color: #92400e; }
        .type-polizze { background: #ede9fe; color: #5b21b6; }
        .type-pip { background: #fee2e2; color: #991b1b; }
        .type-altro { background: #f3f4f6; color: #374151; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--secondary);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            z-index: 10000;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .backup-status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
        }

        .backup-status.ok {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .backup-status.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .backup-status.danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .backup-schedule {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #3b82f6;
        }

        .import-step {
            min-height: 400px;
        }

        .column-mapping:focus {
            outline: none;
            border-color: var(--primary);
        }

        .filters-panel {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
        }

        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-item label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
            color: #374151;
        }

        .filter-item select,
        .filter-item input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .filter-tag {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .filter-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 0;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: relative;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                </svg>
                CRM Consulente Finanziario
            </h1>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalClients">0</div>
                    <div class="stat-label">Clienti Totali</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="activeClients">0</div>
                    <div class="stat-label">Clienti Attivi</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalProspects">0</div>
                    <div class="stat-label">Prospect</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="showTab('clients')">Clienti Attivi</button>
                    <button class="tab-btn" onclick="showTab('prospects')">Prospect</button>
                    <button class="tab-btn" onclick="showTab('all')">Tutti i Contatti</button>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="openAddModal()">
                    + Nuovo Contatto
                </button>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="openImportModal()">
                    📥 Importa da Excel/CSV
                </button>
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px; background: #10b981;" onclick="openQuickImportModal()">
                    ⚡ Import Rapido
                </button>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="exportToExcel()">
                    📤 Esporta in Excel/CSV
                </button>
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px; background: #7c3aed;" onclick="openBackupModal()">
                    🔒 Backup & Sicurezza
                </button>
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px; background: #ec4899; position: relative;" onclick="openBirthdayModal()">
                    🎂 Compleanni
                    <span id="birthdayBadge" style="display: none; position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold;"></span>
                </button>
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px; background: #f59e0b; position: relative;" onclick="openComplianceModal()">
                    📋 Scadenze Compliance
                    <span id="complianceBadge" style="display: none; position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold;"></span>
                </button>
            </div>

            <div class="content-area">
                <div id="clients-tab" class="tab-content active">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" class="search-box" style="flex: 1;" placeholder="Cerca clienti..." onkeyup="searchClients(this.value, 'cliente')">
                        <button class="btn btn-secondary" onclick="toggleFilters('cliente')">
                            🔍 Filtri Avanzati
                        </button>
                    </div>
                    <div id="filters-cliente" class="filters-panel" style="display: none;">
                        <!-- Filtri verranno inseriti qui -->
                    </div>
                    <div id="clients-list" class="client-grid"></div>
                </div>

                <div id="prospects-tab" class="tab-content">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" class="search-box" style="flex: 1;" placeholder="Cerca prospect..." onkeyup="searchClients(this.value, 'prospect')">
                        <button class="btn btn-secondary" onclick="toggleFilters('prospect')">
                            🔍 Filtri Avanzati
                        </button>
                    </div>
                    <div id="filters-prospect" class="filters-panel" style="display: none;">
                        <!-- Filtri verranno inseriti qui -->
                    </div>
                    <div id="prospects-list" class="client-grid"></div>
                </div>

                <div id="all-tab" class="tab-content">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" class="search-box" style="flex: 1;" placeholder="Cerca contatti..." onkeyup="searchClients(this.value, 'all')">
                        <button class="btn btn-secondary" onclick="toggleFilters('all')">
                            🔍 Filtri Avanzati
                        </button>
                    </div>
                    <div id="filters-all" class="filters-panel" style="display: none;">
                        <!-- Filtri verranno inseriti qui -->
                    </div>
                    <div id="all-list" class="client-grid"></div>
                </div>

                <div id="client-detail" class="client-detail"></div>
            </div>
        </div>
    </div>

    <!-- Modal Cliente -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nuovo Cliente</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="clientForm" onsubmit="saveClient(event)">
                <div class="form-group">
                    <label>Nominativo Cliente *</label>
                    <input type="text" id="clientName" required>
                </div>
                <div class="form-group">
                    <label>Data di Nascita</label>
                    <input type="date" id="clientBirthDate" onchange="updateGeneration()">
                </div>
                <div class="form-group">
                    <label>Generazione</label>
                    <select id="clientGeneration">
                        <option value="">Calcolata automaticamente</option>
                        <option value="tradizionalisti">Tradizionalisti (nati prima del 1946)</option>
                        <option value="baby_boomers">Baby Boomers (1946-1964)</option>
                        <option value="generazione_x">Generazione X (1965-1980)</option>
                        <option value="millennials">Millennials (1981-1996)</option>
                        <option value="generazione_z">Generazione Z (1997-2012)</option>
                        <option value="generazione_alpha">Generazione Alpha (dopo il 2012)</option>
                    </select>
                    <small style="color: #666;">Viene calcolata automaticamente dalla data di nascita</small>
                </div>
                <div class="form-group">
                    <label>Codice Fiscale</label>
                    <input type="text" id="clientCF" maxlength="16" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label>Indirizzo (Via/Viale/Piazza)</label>
                    <input type="text" id="clientAddress" placeholder="Es: Via Roma">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>N. Civico</label>
                        <input type="text" id="clientCivic" placeholder="Es: 15/A">
                    </div>
                    <div class="form-group">
                        <label>Comune</label>
                        <input type="text" id="clientCity" placeholder="Es: Milano">
                    </div>
                    <div class="form-group">
                        <label>CAP</label>
                        <input type="text" id="clientZip" maxlength="5" placeholder="Es: 20100">
                    </div>
                </div>
                <div class="form-group">
                    <label>Provincia</label>
                    <input type="text" id="clientProvince" maxlength="2" style="text-transform: uppercase;" placeholder="Es: MI">
                </div>
                <div class="form-group">
                    <label>Telefono</label>
                    <input type="tel" id="clientPhone">
                </div>
                <div class="form-group">
                    <label>Flusso Telefonico</label>
                    <select id="clientPhoneFlow">
                        <option value="">Non specificato</option>
                        <option value="certificato">Numero Certificato</option>
                        <option value="non_certificato">Numero Non Certificato</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="clientEmail">
                </div>
                <div class="form-group">
                    <label>Servizi Online</label>
                    <select id="clientOnlineServices">
                        <option value="">Non specificato</option>
                        <option value="SI">SI</option>
                        <option value="NO">NO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>My Key</label>
                    <select id="clientMyKey">
                        <option value="NESSUN_MYKEY">Nessun MyKey</option>
                        <option value="MYKEY_SMART">MyKey Smart</option>
                        <option value="MYKEY_SMS">MyKey SMS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Profilo MIFID</label>
                    <select id="clientMIFID">
                        <option value="">Non specificato</option>
                        <option value="Conservativo">Conservativo</option>
                        <option value="Moderato">Moderato</option>
                        <option value="Dinamico">Dinamico</option>
                        <option value="Attivo">Attivo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tipo Cliente</label>
                    <select id="clientType">
                        <option value="cliente">Cliente</option>
                        <option value="prospect">Prospect</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="clientNotes"></textarea>
                </div>
                <div class="form-group">
                    <label>Collegamenti Familiari</label>
                    <select id="familyMembers" multiple style="height: 100px;"></select>
                    <small>Ctrl+Click per selezionare più persone</small>
                </div>
                
                <!-- Sezione Compliance/Adempimenti -->
                <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #1e40af; margin-bottom: 15px;">📋 Compliance - Adempimenti Burocratici</h3>
                    
                    <!-- Documento di Identità -->
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #374151; margin-bottom: 10px;">🪪 Documento di Identità</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="form-group">
                                <label>Tipo Documento</label>
                                <select id="docType">
                                    <option value="">Seleziona...</option>
                                    <option value="carta_identita">Carta di Identità</option>
                                    <option value="carta_identita_elettronica">Carta di Identità Elettronica</option>
                                    <option value="patente">Patente di Guida</option>
                                    <option value="passaporto">Passaporto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Numero Documento</label>
                                <input type="text" id="docNumber" style="text-transform: uppercase;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Data Scadenza Documento</label>
                            <input type="date" id="docExpiry">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="form-group">
                                <label>Immagine Fronte</label>
                                <input type="file" id="docImageFront" accept="image/*">
                                <input type="hidden" id="docImageFrontData">
                                <small id="docImageFrontStatus" style="color: #10b981; display: none;">✓ Immagine caricata</small>
                            </div>
                            <div class="form-group">
                                <label>Immagine Retro</label>
                                <input type="file" id="docImageBack" accept="image/*">
                                <input type="hidden" id="docImageBackData">
                                <small id="docImageBackStatus" style="color: #10b981; display: none;">✓ Immagine caricata</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- QAV -->
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #374151; margin-bottom: 10px;">📝 QAV (Questionario Adeguata Verifica)</h4>
                        <div class="form-group">
                            <label>Data Scadenza QAV</label>
                            <input type="date" id="qavExpiry">
                        </div>
                    </div>
                    
                    <!-- MIFID -->
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #374151; margin-bottom: 10px;">📊 Profilo MIFID</h4>
                        <div class="form-group">
                            <label>Data Scadenza MIFID</label>
                            <input type="date" id="mifidExpiry">
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Prodotto -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nuovo Prodotto Finanziario</h2>
                <button class="close-btn" onclick="closeProductModal()">&times;</button>
            </div>
            <form id="productForm" onsubmit="saveProduct(event)">
                <div class="form-group">
                    <label>Nome Prodotto *</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>Tipo *</label>
                    <select id="productType" required>
                        <option value="">Seleziona...</option>
                        <option value="fondi">Fondi</option>
                        <option value="azioni">Azioni</option>
                        <option value="obbligazioni">Obbligazioni</option>
                        <option value="polizze">Polizze</option>
                        <option value="pip">PIP/Fondi Pensione</option>
                        <option value="altro">Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data Sottoscrizione *</label>
                    <input type="date" id="productDate" required>
                </div>
                <div class="form-group">
                    <label>Valore Iniziale (€) *</label>
                    <input type="number" id="productValue" step="0.01" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Incontro -->
    <div id="meetingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nuovo Incontro</h2>
                <button class="close-btn" onclick="closeMeetingModal()">&times;</button>
            </div>
            <form id="meetingForm" onsubmit="saveMeeting(event)">
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" id="meetingDate" required>
                </div>
                <div class="form-group">
                    <label>Note *</label>
                    <textarea id="meetingNotes" required></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeMeetingModal()">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Documento -->
    <div id="documentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Carica Documento</h2>
                <button class="close-btn" onclick="closeDocumentModal()">&times;</button>
            </div>
            <form id="documentForm" onsubmit="saveDocument(event)">
                <div class="form-group">
                    <label>File *</label>
                    <input type="file" id="documentFile" required>
                </div>
                <div class="form-group">
                    <label>Descrizione</label>
                    <input type="text" id="documentDesc">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeDocumentModal()">Annulla</button>
                    <button type="submit" class="btn btn-primary">Carica</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Import -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Importa Clienti da Excel/CSV</h2>
                <button class="close-btn" onclick="closeImportModal()">&times;</button>
            </div>
            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">📋 Formato richiesto:</h4>
                <p style="font-size: 14px; color: #666;">Il file deve contenere le seguenti colonne (l'ordine è importante):</p>
                <ol style="font-size: 14px; color: #666; margin-left: 20px;">
                    <li>Nominativo Cliente (obbligatorio)</li>
                    <li>Data di Nascita (formato: GG/MM/AAAA)</li>
                    <li>Codice Fiscale</li>
                    <li>Residenza</li>
                    <li>Telefono</li>
                    <li>Flusso Telefonico (certificato/non_certificato)</li>
                    <li>Email</li>
                    <li>Servizi Online (SI/NO)</li>
                    <li>My Key (MYKEY_SMART/MYKEY_SMS/NESSUN_MYKEY)</li>
                    <li>Profilo MIFID (Conservativo/Moderato/Dinamico/Attivo)</li>
                    <li>Tipo (cliente/prospect)</li>
                    <li>Note</li>
                </ol>
                <button class="btn btn-secondary btn-small" onclick="downloadTemplate()" style="margin-top: 10px;">
                    📄 Scarica Template Excel
                </button>
            </div>
            <form id="importForm" onsubmit="importClients(event)">
                <div class="form-group">
                    <label>Seleziona file Excel o CSV *</label>
                    <input type="file" id="importFile" accept=".csv,.xlsx,.xls" required onchange="previewImport(event)">
                </div>
                <div id="importPreview" style="display: none; margin-top: 20px;">
                    <h4>Anteprima importazione:</h4>
                    <div id="previewContent" style="max-height: 300px; overflow-y: auto; background: #f5f5f5; padding: 10px; border-radius: 8px; font-size: 14px;"></div>
                    <p id="importSummary" style="margin-top: 10px; font-weight: bold;"></p>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeImportModal()">Annulla</button>
                    <button type="submit" class="btn btn-primary" id="importBtn" disabled>Importa</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Import Rapido -->
    <div id="quickImportModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>⚡ Import Rapido - Importa i tuoi contatti in 3 semplici passi</h2>
                <button class="close-btn" onclick="closeQuickImportModal()">&times;</button>
            </div>
            
            <!-- Step 1: Upload o Incolla -->
            <div id="quickImportStep1" class="import-step">
                <h3 style="color: var(--primary); margin-bottom: 20px;">Passo 1: Carica o incolla i tuoi dati</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Upload File -->
                    <div style="background: #f0f9ff; padding: 30px; border-radius: 12px; text-align: center; border: 2px dashed #3b82f6;">
                        <div style="font-size: 48px; margin-bottom: 10px;">📁</div>
                        <h4>Carica un file</h4>
                        <p style="color: #666; margin: 10px 0;">CSV, Excel o qualsiasi file di testo</p>
                        <input type="file" id="quickImportFile" accept=".csv,.xlsx,.xls,.txt" style="display: none;" onchange="handleQuickImportFile(event)">
                        <button class="btn btn-primary" onclick="document.getElementById('quickImportFile').click()">
                            Seleziona File
                        </button>
                    </div>
                    
                    <!-- Incolla Testo -->
                    <div style="background: #f0fdf4; padding: 30px; border-radius: 12px; text-align: center; border: 2px dashed #10b981;">
                        <div style="font-size: 48px; margin-bottom: 10px;">📋</div>
                        <h4>Incolla i dati</h4>
                        <p style="color: #666; margin: 10px 0;">Copia da Excel o qualsiasi fonte</p>
                        <button class="btn btn-secondary" style="background: #10b981;" onclick="showPasteArea()">
                            Incolla Testo
                        </button>
                    </div>
                </div>
                
                <!-- Area incolla (nascosta inizialmente) -->
                <div id="pasteArea" style="display: none; margin-top: 20px;">
                    <textarea id="pasteTextarea" style="width: 100%; height: 200px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: monospace;" placeholder="Incolla qui i tuoi dati...&#10;&#10;Esempi supportati:&#10;Mario Rossi, 333-1234567, mario@email.com&#10;Luigi Bianchi | 335-9876543 | luigi@email.com&#10;Anna Verdi - anna@email.com - Via Roma 15"></textarea>
                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="processPastedData()">
                        Analizza Dati
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Mapping Colonne -->
            <div id="quickImportStep2" class="import-step" style="display: none;">
                <h3 style="color: var(--primary); margin-bottom: 20px;">Passo 2: Conferma il riconoscimento dei campi</h3>
                
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0;"><strong>💡 Suggerimento:</strong> Abbiamo riconosciuto automaticamente i campi. Verifica e correggi se necessario.</p>
                </div>
                
                <div id="columnMappingArea" style="margin-bottom: 20px;">
                    <!-- Mapping dinamico verrà inserito qui -->
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="backToStep1()">← Indietro</button>
                    <button class="btn btn-primary" onclick="goToStep3()">Continua →</button>
                </div>
            </div>
            
            <!-- Step 3: Preview e Import -->
            <div id="quickImportStep3" class="import-step" style="display: none;">
                <h3 style="color: var(--primary); margin-bottom: 20px;">Passo 3: Verifica e importa</h3>
                
                <div id="quickImportPreview" style="max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <!-- Preview dati -->
                </div>
                
                <div id="quickImportSummary" style="background: #d1fae5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <!-- Riepilogo -->
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="backToStep2()">← Indietro</button>
                    <button class="btn btn-primary" style="background: var(--secondary);" onclick="executeQuickImport()">
                        ✅ Importa Contatti
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Backup -->
    <div id="backupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔒 Backup & Sicurezza</h2>
                <button class="close-btn" onclick="closeBackupModal()">&times;</button>
            </div>
            
            <div id="backupStatus" class="backup-status">
                <!-- Status will be updated dynamically -->
            </div>

            <div class="backup-schedule">
                <h3>⏰ Backup Automatico Settimanale</h3>
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="autoBackup" onchange="toggleAutoBackup()" style="width: 20px; height: 20px;">
                        <span>Attiva promemoria backup settimanale</span>
                    </label>
                </div>
                <div id="backupDaySelect" style="display: none; margin-top: 15px;">
                    <label>Giorno della settimana per il backup:</label>
                    <select id="backupDay" onchange="updateBackupDay()" style="width: 100%; padding: 8px; margin-top: 5px;">
                        <option value="1">Lunedì</option>
                        <option value="2">Martedì</option>
                        <option value="3">Mercoledì</option>
                        <option value="4">Giovedì</option>
                        <option value="5">Venerdì</option>
                        <option value="6">Sabato</option>
                        <option value="0">Domenica</option>
                    </select>
                </div>
                <p id="nextBackupInfo" style="margin-top: 15px; color: #666; font-size: 14px;"></p>
            </div>

            <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3>📊 Statistiche Database</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                    <div>
                        <strong>Clienti totali:</strong> <span id="backupTotalClients">0</span>
                    </div>
                    <div>
                        <strong>Prodotti totali:</strong> <span id="backupTotalProducts">0</span>
                    </div>
                    <div>
                        <strong>Documenti totali:</strong> <span id="backupTotalDocs">0</span>
                    </div>
                    <div>
                        <strong>Incontri totali:</strong> <span id="backupTotalMeetings">0</span>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <strong>Ultimo backup:</strong> <span id="lastBackupDate">Mai effettuato</span>
                </div>
            </div>
            
            <!-- Indicatore Spazio Storage -->
            <div style="background: #e0e7ff; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3>💾 Utilizzo Spazio Storage</h3>
                <div style="margin-top: 15px;">
                    <div style="background: #e5e7eb; border-radius: 10px; height: 20px; overflow: hidden; position: relative;">
                        <div id="storageBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <span id="storageUsed" style="font-weight: bold;">0 MB</span>
                        <span id="storagePercent" style="color: #666;">0%</span>
                        <span style="color: #666;">Limite: ~10 MB</span>
                    </div>
                    <div id="storageWarning" style="display: none; margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 6px; color: #92400e;">
                        ⚠️ Attenzione: stai utilizzando molto spazio. Considera di fare pulizia o esportare vecchi dati.
                    </div>
                    <div id="storageCritical" style="display: none; margin-top: 10px; padding: 10px; background: #fee2e2; border-radius: 6px; color: #991b1b;">
                        ❌ Spazio quasi esaurito! Elimina alcuni documenti o immagini per continuare.
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <button class="btn btn-primary" onclick="backupFull()">
                    💾 Backup Completo (JSON)
                </button>
                <button class="btn btn-secondary" onclick="backupExcel()">
                    📊 Backup Excel (CSV)
                </button>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                <h4 style="margin-bottom: 10px;">🔄 Ripristina Backup</h4>
                <p style="font-size: 14px; color: #666; margin-bottom: 10px;">Carica un file di backup JSON precedentemente salvato</p>
                <button class="btn btn-secondary" onclick="restoreBackup()">
                    📂 Carica Backup
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Compleanni -->
    <div id="birthdayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🎂 Compleanni e Promemoria</h2>
                <button class="close-btn" onclick="closeBirthdayModal()">&times;</button>
            </div>
            
            <div id="birthdayTodaySection" style="display: none;">
                <div style="background: #fef3c7; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #92400e; margin-bottom: 15px;">🎉 Compleanni di Oggi</h3>
                    <div id="birthdaysToday"></div>
                </div>
            </div>
            
            <div id="birthdayWeekSection" style="display: none;">
                <div style="background: #dbeafe; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #1e40af; margin-bottom: 15px;">📅 Compleanni dei Prossimi 7 Giorni</h3>
                    <div id="birthdaysWeek"></div>
                </div>
            </div>
            
            <div id="birthdayMonthSection" style="display: none;">
                <div style="background: #f3e8ff; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #6b21a8; margin-bottom: 15px;">📆 Compleanni del Mese</h3>
                    <div id="birthdaysMonth"></div>
                </div>
            </div>
            
            <div id="noBirthdaysMessage" style="display: none; text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 10px;">🎂</div>
                <p>Nessun compleanno in programma nei prossimi 30 giorni</p>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="birthdayNotifications" onchange="toggleBirthdayNotifications()" style="width: 20px; height: 20px;">
                    <span>Mostra promemoria compleanni all'avvio</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Modal Movimento Prodotto -->
    <div id="movementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registra Movimento</h2>
                <button class="close-btn" onclick="closeMovementModal()">&times;</button>
            </div>
            <form id="movementForm" onsubmit="saveMovement(event)">
                <div class="form-group">
                    <label>Tipo Movimento *</label>
                    <select id="movementType" required onchange="updateMovementLabel()">
                        <option value="">Seleziona...</option>
                        <option value="versamento">Versamento Aggiuntivo</option>
                        <option value="disinvestimento">Disinvestimento Parziale</option>
                        <option value="switch">Switch/Cambio Linea</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data Movimento *</label>
                    <input type="date" id="movementDate" required>
                </div>
                <div class="form-group">
                    <label id="movementAmountLabel">Importo (€) *</label>
                    <input type="number" id="movementAmount" step="0.01" required>
                    <small id="movementAmountHelp" style="color: #666;">Inserire l'importo del movimento</small>
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="movementNotes" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeMovementModal()">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva Movimento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Valorizzazione Annuale -->
    <div id="valuationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Valorizzazione Annuale</h2>
                <button class="close-btn" onclick="closeValuationModal()">&times;</button>
            </div>
            <form id="valuationForm" onsubmit="saveValuation(event)">
                <div class="form-group">
                    <label>Anno *</label>
                    <select id="valuationYear" required>
                        <!-- Opzioni generate dinamicamente -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Controvalore al 31/12 (€) *</label>
                    <input type="number" id="valuationAmount" step="0.01" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>Performance %</label>
                        <input type="number" id="valuationPerformance" step="0.01" readonly style="background: #f3f4f6;">
                    </div>
                    <div class="form-group">
                        <label>Performance €</label>
                        <input type="text" id="valuationPerformanceEuro" readonly style="background: #f3f4f6;">
                    </div>
                </div>
                <small style="color: #666; display: block; margin-top: -15px; margin-bottom: 15px;">Calcolate automaticamente</small>
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="valuationNotes" rows="3" placeholder="Es: Performance influenzata da..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeValuationModal()">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva Valorizzazione</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Scadenze Compliance -->
    <div id="complianceModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>📋 Scadenze Compliance - Adempimenti Burocratici</h2>
                <button class="close-btn" onclick="closeComplianceModal()">&times;</button>
            </div>
            
            <div id="complianceExpiredSection" style="display: none;">
                <div style="background: #fee2e2; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #991b1b; margin-bottom: 15px;">❌ Documenti SCADUTI</h3>
                    <div id="complianceExpired"></div>
                </div>
            </div>
            
            <div id="complianceExpiringSection" style="display: none;">
                <div style="background: #fef3c7; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #92400e; margin-bottom: 15px;">⚠️ In Scadenza (prossimi 30 giorni)</h3>
                    <div id="complianceExpiring"></div>
                </div>
            </div>
            
            <div id="complianceUpcomingSection" style="display: none;">
                <div style="background: #dbeafe; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #1e40af; margin-bottom: 15px;">📅 Scadenze Future</h3>
                    <div id="complianceUpcoming"></div>
                </div>
            </div>
            
            <div id="noComplianceMessage" style="display: none; text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 10px;">📋</div>
                <p>Nessuna scadenza di compliance registrata</p>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="complianceNotifications" onchange="toggleComplianceNotifications()" style="width: 20px; height: 20px;">
                    <span>Mostra promemoria scadenze all'avvio</span>
                </label>
            </div>
            
            <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
                <button class="btn btn-primary" onclick="exportComplianceReport()">
                    📄 Esporta Report Scadenze
                </button>
            </div>
        </div>
    </div>

    <script>
        let clients = [];
        let currentEditId = null;
        let currentClientId = null;

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            renderLists();
            updateStats();
            updateBirthdayBadge();
            updateComplianceBadge();
            checkStorageStatus();
            initializeFilters();
            initializeDocumentUploads();
            initializeValuationListener();
            checkBackupReminder();
            checkBirthdaysOnStartup();
            checkComplianceOnStartup();
        });

        // Tabs
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Modal
        function openAddModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Nuovo Cliente';
            document.getElementById('clientForm').reset();
            document.getElementById('clientMyKey').value = 'NESSUN_MYKEY';
            // Reset campi compliance
            document.getElementById('docImageFrontData').value = '';
            document.getElementById('docImageBackData').value = '';
            document.getElementById('docImageFrontStatus').style.display = 'none';
            document.getElementById('docImageBackStatus').style.display = 'none';
            updateFamilySelect();
            document.getElementById('clientModal').style.display = 'block';
        }

        function openEditModal(id) {
            currentEditId = id;
            const client = clients.find(c => c.id === id);
            document.getElementById('modalTitle').textContent = 'Modifica Cliente';
            
            // Reset TUTTI i campi prima di caricare i nuovi dati
            document.getElementById('clientForm').reset();
            document.getElementById('docImageFrontData').value = '';
            document.getElementById('docImageBackData').value = '';
            document.getElementById('docImageFrontStatus').style.display = 'none';
            document.getElementById('docImageBackStatus').style.display = 'none';
            
            // Ora carica i dati del cliente
            document.getElementById('clientName').value = client.name;
            document.getElementById('clientBirthDate').value = client.birthDate || '';
            document.getElementById('clientGeneration').value = client.generation || calculateGeneration(client.birthDate);
            document.getElementById('clientCF').value = client.cf || '';
            document.getElementById('clientAddress').value = client.address || '';
            document.getElementById('clientCivic').value = client.civic || '';
            document.getElementById('clientCity').value = client.city || '';
            document.getElementById('clientZip').value = client.zip || '';
            document.getElementById('clientProvince').value = client.province || '';
            document.getElementById('clientPhone').value = client.phone || '';
            document.getElementById('clientPhoneFlow').value = client.phoneFlow || '';
            document.getElementById('clientEmail').value = client.email || '';
            document.getElementById('clientOnlineServices').value = client.onlineServices || '';
            document.getElementById('clientMyKey').value = client.myKey || 'NESSUN_MYKEY';
            document.getElementById('clientMIFID').value = client.mifid || '';
            document.getElementById('clientType').value = client.type;
            document.getElementById('clientNotes').value = client.notes || '';
            
            // Carica dati compliance
            if (client.compliance) {
                if (client.compliance.document) {
                    document.getElementById('docType').value = client.compliance.document.type || '';
                    document.getElementById('docNumber').value = client.compliance.document.number || '';
                    document.getElementById('docExpiry').value = client.compliance.document.expiry || '';
                    document.getElementById('docImageFrontData').value = client.compliance.document.imageFront || '';
                    document.getElementById('docImageBackData').value = client.compliance.document.imageBack || '';
                } else {
                    // Reset se non ci sono dati documento
                    document.getElementById('docType').value = '';
                    document.getElementById('docNumber').value = '';
                    document.getElementById('docExpiry').value = '';
                }
                
                if (client.compliance.qav) {
                    document.getElementById('qavExpiry').value = client.compliance.qav.expiry || '';
                } else {
                    document.getElementById('qavExpiry').value = '';
                }
                
                if (client.compliance.mifid) {
                    document.getElementById('mifidExpiry').value = client.compliance.mifid.expiry || '';
                } else {
                    document.getElementById('mifidExpiry').value = '';
                }
            } else {
                // Reset tutti i campi compliance se non ci sono dati
                document.getElementById('docType').value = '';
                document.getElementById('docNumber').value = '';
                document.getElementById('docExpiry').value = '';
                document.getElementById('qavExpiry').value = '';
                document.getElementById('mifidExpiry').value = '';
            }
            
            // Aggiorna stato immagini
            updateImageStatus();
            
            updateFamilySelect();
            if (client.familyMembers) {
                const select = document.getElementById('familyMembers');
                Array.from(select.options).forEach(opt => {
                    opt.selected = client.familyMembers.includes(opt.value);
                });
            }
            document.getElementById('clientModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('clientModal').style.display = 'none';
            // Reset completo dei campi immagine
            document.getElementById('docImageFront').value = '';
            document.getElementById('docImageBack').value = '';
            document.getElementById('docImageFrontData').value = '';
            document.getElementById('docImageBackData').value = '';
            document.getElementById('docImageFrontStatus').style.display = 'none';
            document.getElementById('docImageBackStatus').style.display = 'none';
        }

        function updateFamilySelect() {
            const select = document.getElementById('familyMembers');
            select.innerHTML = clients
                .filter(c => !currentEditId || c.id !== currentEditId)
                .map(c => `<option value="${c.id}">${c.name}</option>`)
                .join('');
        }

        // Document Upload Functions for Compliance
        function initializeDocumentUploads() {
            // Gestione upload fronte documento
            const docFront = document.getElementById('docImageFront');
            if (docFront) {
                docFront.addEventListener('change', function(e) {
                    handleDocumentImageUpload(e, 'docImageFrontData');
                });
            }
            
            // Gestione upload retro documento
            const docBack = document.getElementById('docImageBack');
            if (docBack) {
                docBack.addEventListener('change', function(e) {
                    handleDocumentImageUpload(e, 'docImageBackData');
                });
            }
        }

        function handleDocumentImageUpload(event, targetFieldId) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Verifica dimensione file (max 2MB per sicurezza)
            if (file.size > 2 * 1024 * 1024) {
                alert('Il file è troppo grande. Dimensione massima: 2MB');
                event.target.value = '';
                return;
            }
            
            // Verifica tipo file
            if (!file.type.startsWith('image/')) {
                alert('Seleziona un file immagine valido');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Comprimi l'immagine prima di salvarla
                compressImage(e.target.result, function(compressedData) {
                    document.getElementById(targetFieldId).value = compressedData;
                    showNotification('Immagine caricata con successo');
                });
            };
            reader.onerror = function() {
                alert('Errore nel caricamento del file');
                event.target.value = '';
            };
            reader.readAsDataURL(file);
        }
        
        function compressImage(dataUrl, callback) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Imposta dimensioni massime
                const maxWidth = 800;
                const maxHeight = 600;
                let width = img.width;
                let height = img.height;
                
                // Calcola le nuove dimensioni mantenendo le proporzioni
                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Disegna l'immagine compressa
                ctx.drawImage(img, 0, 0, width, height);
                
                // Converti in JPEG con qualità ridotta
                const compressedData = canvas.toDataURL('image/jpeg', 0.7);
                callback(compressedData);
            };
            img.onerror = function() {
                alert('Errore nel processamento dell\'immagine');
                callback('');
            };
            img.src = dataUrl;
        }
        
        function updateImageStatus() {
            // Mostra/nascondi indicatori di caricamento
            const frontData = document.getElementById('docImageFrontData').value;
            const backData = document.getElementById('docImageBackData').value;
            
            document.getElementById('docImageFrontStatus').style.display = frontData ? 'block' : 'none';
            document.getElementById('docImageBackStatus').style.display = backData ? 'block' : 'none';
        }

        // Generation Functions
        function calculateGeneration(birthDate) {
            if (!birthDate) return '';
            
            const year = new Date(birthDate).getFullYear();
            
            if (year < 1946) return 'tradizionalisti';
            if (year >= 1946 && year <= 1964) return 'baby_boomers';
            if (year >= 1965 && year <= 1980) return 'generazione_x';
            if (year >= 1981 && year <= 1996) return 'millennials';
            if (year >= 1997 && year <= 2012) return 'generazione_z';
            if (year > 2012) return 'generazione_alpha';
            
            return '';
        }
        
        function updateGeneration() {
            const birthDate = document.getElementById('clientBirthDate').value;
            if (birthDate) {
                const generation = calculateGeneration(birthDate);
                document.getElementById('clientGeneration').value = generation;
            }
        }
        
        function getGenerationLabel(generation) {
            const labels = {
                'tradizionalisti': 'Tradizionalisti',
                'baby_boomers': 'Baby Boomers',
                'generazione_x': 'Generazione X',
                'millennials': 'Millennials',
                'generazione_z': 'Generazione Z',
                'generazione_alpha': 'Generazione Alpha'
            };
            return labels[generation] || '';
        }
        
        function getGenerationColor(generation) {
            const colors = {
                'tradizionalisti': '#6b7280',
                'baby_boomers': '#8b5cf6',
                'generazione_x': '#3b82f6',
                'millennials': '#10b981',
                'generazione_z': '#f59e0b',
                'generazione_alpha': '#ec4899'
            };
            return colors[generation] || '#6b7280';
        }

        // Save Client
        function saveClient(event) {
            event.preventDefault();
            
            try {
                const data = {
                    name: document.getElementById('clientName').value,
                    birthDate: document.getElementById('clientBirthDate').value,
                    generation: document.getElementById('clientGeneration').value || calculateGeneration(document.getElementById('clientBirthDate').value),
                    cf: document.getElementById('clientCF').value.toUpperCase(),
                    address: document.getElementById('clientAddress').value,
                    civic: document.getElementById('clientCivic').value,
                    city: document.getElementById('clientCity').value,
                    zip: document.getElementById('clientZip').value,
                    province: document.getElementById('clientProvince').value.toUpperCase(),
                    phone: document.getElementById('clientPhone').value,
                    phoneFlow: document.getElementById('clientPhoneFlow').value,
                    email: document.getElementById('clientEmail').value,
                    onlineServices: document.getElementById('clientOnlineServices').value,
                    myKey: document.getElementById('clientMyKey').value,
                    mifid: document.getElementById('clientMIFID').value,
                    type: document.getElementById('clientType').value,
                    notes: document.getElementById('clientNotes').value,
                    familyMembers: Array.from(document.getElementById('familyMembers').selectedOptions).map(o => o.value),
                    // Nuovi campi compliance
                    compliance: {
                        document: {
                            type: document.getElementById('docType').value,
                            number: document.getElementById('docNumber').value.toUpperCase(),
                            expiry: document.getElementById('docExpiry').value,
                            imageFront: document.getElementById('docImageFrontData').value,
                            imageBack: document.getElementById('docImageBackData').value
                        },
                        qav: {
                            expiry: document.getElementById('qavExpiry').value
                        },
                        mifid: {
                            expiry: document.getElementById('mifidExpiry').value
                        }
                    }
                };
                
                if (currentEditId) {
                    const index = clients.findIndex(c => c.id === currentEditId);
                    clients[index] = { ...clients[index], ...data };
                } else {
                    data.id = Date.now().toString();
                    data.createdAt = new Date().toISOString();
                    data.products = [];
                    data.meetings = [];
                    data.documents = [];
                    clients.push(data);
                }
                
                // Prova a salvare
                saveData();
                renderLists();
                updateStats();
                updateBirthdayBadge();
                updateComplianceBadge();
                closeModal();
                showNotification('Cliente salvato!');
                
            } catch (error) {
                console.error('Errore nel salvataggio:', error);
                
                // Se l'errore è dovuto alla dimensione, prova a salvare senza immagini
                if (error.name === 'QuotaExceededError' || error.message.includes('quota')) {
                    if (confirm('Le immagini sono troppo grandi per essere salvate. Vuoi salvare il cliente senza le immagini del documento?')) {
                        // Rimuovi le immagini e riprova
                        document.getElementById('docImageFrontData').value = '';
                        document.getElementById('docImageBackData').value = '';
                        document.getElementById('docImageFront').value = '';
                        document.getElementById('docImageBack').value = '';
                        
                        // Richiama la funzione ricorsivamente
                        saveClient(event);
                    }
                } else {
                    alert('Errore durante il salvataggio. Riprova.');
                }
            }
        }

        function deleteClient(id) {
            if (confirm('Eliminare questo cliente?')) {
                clients = clients.filter(c => c.id !== id);
                saveData();
                renderLists();
                updateStats();
            }
        }

        // Show Client Detail
        function showClientDetail(id) {
            currentClientId = id;
            const client = clients.find(c => c.id === id);
            
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('client-detail').classList.add('active');
            
            const familyHtml = client.familyMembers && client.familyMembers.length > 0
                ? client.familyMembers.map(fId => {
                    const member = clients.find(c => c.id === fId);
                    return member ? `<span style="display: inline-block; padding: 5px 10px; background: var(--primary); color: white; border-radius: 15px; margin: 2px; cursor: pointer;" onclick="showClientDetail('${fId}')">${member.name}</span>` : '';
                }).join('')
                : '<span style="color: #999;">Nessun collegamento</span>';
            
            // Calculate age if birthDate exists
            const age = client.birthDate ? 
                Math.floor((new Date() - new Date(client.birthDate)) / (365.25 * 24 * 60 * 60 * 1000)) : null;
            
            document.getElementById('client-detail').innerHTML = `
                <div style="margin-bottom: 30px;">
                    <button class="btn btn-secondary" onclick="backToList()">← Torna alla lista</button>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h2 style="display: inline-block; margin-right: 10px;">${client.name}</h2>
                    <span class="client-type ${client.type === 'prospect' ? 'prospect' : ''}">${client.type}</span>
                    ${client.generation || client.birthDate ? `
                        <span style="background: ${getGenerationColor(client.generation || calculateGeneration(client.birthDate))}; color: white; padding: 4px 12px; border-radius: 15px; font-size: 14px; margin-left: 10px;">
                            ${getGenerationLabel(client.generation || calculateGeneration(client.birthDate))}
                        </span>
                    ` : ''}
                    <button class="btn btn-primary btn-small" style="float: right;" onclick="openEditModal('${client.id}')">Modifica</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f9fafb; padding: 20px; border-radius: 10px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Dati Anagrafici</h4>
                        ${client.birthDate ? `<p><strong>Data di Nascita:</strong> ${new Date(client.birthDate).toLocaleDateString('it-IT')} (${age} anni)</p>` : ''}
                        ${client.cf ? `<p><strong>Codice Fiscale:</strong> ${client.cf}</p>` : ''}
                        ${(client.address || client.city) ? `
                            <div style="margin-top: 10px;">
                                <p><strong>Indirizzo:</strong></p>
                                <p style="margin-left: 10px;">${[
                                    client.address,
                                    client.civic,
                                    client.zip,
                                    client.city,
                                    client.province ? `(${client.province})` : ''
                                ].filter(Boolean).join(' ')}</p>
                                ${client.address && client.city ? `
                                    <button class="btn btn-secondary btn-small" style="margin-top: 10px;" onclick="openGoogleMaps('${client.id}')">
                                        📍 Apri in Google Maps
                                    </button>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="background: #f9fafb; padding: 20px; border-radius: 10px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Contatti</h4>
                        ${client.phone ? `
                            <div style="margin-bottom: 10px;">
                                <p><strong>Telefono:</strong> ${client.phone} 
                                ${client.phoneFlow ? `<span style="background: ${client.phoneFlow === 'certificato' ? '#10b981' : '#f59e0b'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">${client.phoneFlow === 'certificato' ? '✓ Certificato' : '⚠ Non Certificato'}</span>` : ''}</p>
                                <button class="btn btn-secondary btn-small" style="margin-top: 8px; background: #25D366;" onclick="openWhatsApp('${client.phone}')">
                                    <span style="font-size: 16px;">📱</span> WhatsApp
                                </button>
                            </div>
                        ` : ''}
                        ${client.email ? `
                            <div>
                                <p><strong>Email:</strong> ${client.email}</p>
                                <button class="btn btn-secondary btn-small" style="margin-top: 8px; background: #EA4335;" onclick="sendEmail('${client.email}', '${client.name}')">
                                    <span style="font-size: 16px;">📧</span> Invia Email
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="background: #f9fafb; padding: 20px; border-radius: 10px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Servizi Digitali</h4>
                        <p><strong>Servizi Online:</strong> ${client.onlineServices ? 
                            `<span style="background: ${client.onlineServices === 'SI' ? '#10b981' : '#ef4444'}; color: white; padding: 2px 12px; border-radius: 12px;">${client.onlineServices}</span>` : 
                            '<span style="color: #999;">Non specificato</span>'}</p>
                        <p><strong>My Key:</strong> <span style="background: ${client.myKey === 'MYKEY_SMART' ? '#3b82f6' : client.myKey === 'MYKEY_SMS' ? '#8b5cf6' : '#6b7280'}; color: white; padding: 2px 12px; border-radius: 12px; font-size: 14px;">${client.myKey ? client.myKey.replace(/_/g, ' ') : 'NESSUN MYKEY'}</span></p>
                    </div>
                    
                    <div style="background: #f9fafb; padding: 20px; border-radius: 10px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Profilo Finanziario</h4>
                        ${client.mifid ? `<p><strong>Profilo MIFID:</strong> <span style="background: ${
                            client.mifid === 'Conservativo' ? '#10b981' : 
                            client.mifid === 'Moderato' ? '#3b82f6' : 
                            client.mifid === 'Dinamico' ? '#f59e0b' : 
                            client.mifid === 'Attivo' ? '#ef4444' : '#6b7280'
                        }; color: white; padding: 4px 16px; border-radius: 20px; font-weight: 500;">${client.mifid}</span></p>` : '<p style="color: #999;">Profilo MIFID non specificato</p>'}
                    </div>
                </div>
                
                ${client.notes ? `
                    <div style="background: #fef3c7; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #92400e; margin-bottom: 10px;">📝 Note</h4>
                        <p style="color: #92400e;">${client.notes}</p>
                    </div>
                ` : ''}
                
                <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #1e40af; margin-bottom: 10px;">👨‍👩‍👧‍👦 Collegamenti Familiari</h4>
                    ${familyHtml}
                </div>
                
                ${renderComplianceSection(client)}
                
                <div class="section">
                    <div class="section-header">
                        <h3>Documenti</h3>
                        <button class="btn btn-primary btn-small" onclick="openDocumentModal()">+ Documento</button>
                    </div>
                    <div id="documents-list">
                        ${renderDocuments(client)}
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h3>Prodotti Finanziari</h3>
                        <button class="btn btn-primary btn-small" onclick="openProductModal()">+ Prodotto</button>
                    </div>
                    <div id="products-list">
                        ${renderProducts(client)}
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h3>Incontri</h3>
                        <button class="btn btn-primary btn-small" onclick="openMeetingModal()">+ Incontro</button>
                    </div>
                    <div id="meetings-list">
                        ${renderMeetings(client)}
                    </div>
                </div>
            `;
        }

        function backToList() {
            document.getElementById('client-detail').classList.remove('active');
            document.getElementById('clients-tab').classList.add('active');
            document.querySelector('.tab-btn').classList.add('active');
        }

        function renderComplianceSection(client) {
            if (!client.compliance) {
                return '';
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let html = `
                <div style="background: #fef3c7; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #92400e; margin-bottom: 20px;">📋 Compliance - Adempimenti Burocratici</h3>
            `;
            
            // Documento di Identità
            if (client.compliance.document && client.compliance.document.type) {
                const docExpiry = client.compliance.document.expiry ? new Date(client.compliance.document.expiry) : null;
                const daysUntilExpiry = docExpiry ? Math.ceil((docExpiry - today) / (1000 * 60 * 60 * 24)) : null;
                const isExpired = daysUntilExpiry !== null && daysUntilExpiry < 0;
                const isExpiringSoon = daysUntilExpiry !== null && daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
                
                const docTypeLabels = {
                    'carta_identita': 'Carta di Identità',
                    'carta_identita_elettronica': 'Carta di Identità Elettronica',
                    'patente': 'Patente di Guida',
                    'passaporto': 'Passaporto'
                };
                
                html += `
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; ${isExpired ? 'border: 2px solid #ef4444;' : isExpiringSoon ? 'border: 2px solid #f59e0b;' : ''}">
                        <h4 style="color: ${isExpired ? '#ef4444' : '#374151'};">🪪 Documento di Identità</h4>
                        <p><strong>Tipo:</strong> ${docTypeLabels[client.compliance.document.type] || client.compliance.document.type}</p>
                        ${client.compliance.document.number ? `<p><strong>Numero:</strong> ${client.compliance.document.number}</p>` : ''}
                        ${docExpiry ? `
                            <p><strong>Scadenza:</strong> ${docExpiry.toLocaleDateString('it-IT')} 
                            ${isExpired ? `<span style="color: #ef4444; font-weight: bold;"> (SCADUTO da ${Math.abs(daysUntilExpiry)} giorni)</span>` : 
                              isExpiringSoon ? `<span style="color: #f59e0b; font-weight: bold;"> (Scade tra ${daysUntilExpiry} giorni)</span>` : 
                              `<span style="color: #10b981;"> (Valido)</span>`}
                            </p>
                        ` : ''}
                        ${(client.compliance.document.imageFront || client.compliance.document.imageBack) ? `
                            <div style="margin-top: 10px;">
                                ${client.compliance.document.imageFront ? `
                                    <button class="btn btn-secondary btn-small" onclick="viewDocumentImage('${client.id}', 'front')">
                                        👁️ Visualizza Fronte
                                    </button>
                                ` : ''}
                                ${client.compliance.document.imageBack ? `
                                    <button class="btn btn-secondary btn-small" onclick="viewDocumentImage('${client.id}', 'back')">
                                        👁️ Visualizza Retro
                                    </button>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // QAV
            if (client.compliance.qav && client.compliance.qav.expiry) {
                const qavExpiry = new Date(client.compliance.qav.expiry);
                const daysUntilExpiry = Math.ceil((qavExpiry - today) / (1000 * 60 * 60 * 24));
                const isExpired = daysUntilExpiry < 0;
                const isExpiringSoon = daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
                
                html += `
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; ${isExpired ? 'border: 2px solid #ef4444;' : isExpiringSoon ? 'border: 2px solid #f59e0b;' : ''}">
                        <h4 style="color: ${isExpired ? '#ef4444' : '#374151'};">📝 QAV (Questionario Adeguata Verifica)</h4>
                        <p><strong>Scadenza:</strong> ${qavExpiry.toLocaleDateString('it-IT')} 
                        ${isExpired ? `<span style="color: #ef4444; font-weight: bold;"> (SCADUTO da ${Math.abs(daysUntilExpiry)} giorni)</span>` : 
                          isExpiringSoon ? `<span style="color: #f59e0b; font-weight: bold;"> (Scade tra ${daysUntilExpiry} giorni)</span>` : 
                          `<span style="color: #10b981;"> (Valido)</span>`}
                        </p>
                    </div>
                `;
            }
            
            // MIFID
            if (client.compliance.mifid && client.compliance.mifid.expiry) {
                const mifidExpiry = new Date(client.compliance.mifid.expiry);
                const daysUntilExpiry = Math.ceil((mifidExpiry - today) / (1000 * 60 * 60 * 24));
                const isExpired = daysUntilExpiry < 0;
                const isExpiringSoon = daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
                
                html += `
                    <div style="background: white; padding: 15px; border-radius: 8px; ${isExpired ? 'border: 2px solid #ef4444;' : isExpiringSoon ? 'border: 2px solid #f59e0b;' : ''}">
                        <h4 style="color: ${isExpired ? '#ef4444' : '#374151'};">📊 Profilo MIFID</h4>
                        <p><strong>Profilo:</strong> <span style="background: ${
                            client.mifid === 'Conservativo' ? '#10b981' : 
                            client.mifid === 'Moderato' ? '#3b82f6' : 
                            client.mifid === 'Dinamico' ? '#f59e0b' : 
                            client.mifid === 'Attivo' ? '#ef4444' : '#6b7280'
                        }; color: white; padding: 2px 12px; border-radius: 12px;">${client.mifid || 'Non specificato'}</span></p>
                        <p><strong>Scadenza:</strong> ${mifidExpiry.toLocaleDateString('it-IT')} 
                        ${isExpired ? `<span style="color: #ef4444; font-weight: bold;"> (SCADUTO da ${Math.abs(daysUntilExpiry)} giorni)</span>` : 
                          isExpiringSoon ? `<span style="color: #f59e0b; font-weight: bold;"> (Scade tra ${daysUntilExpiry} giorni)</span>` : 
                          `<span style="color: #10b981;"> (Valido)</span>`}
                        </p>
                    </div>
                `;
            }
            
            html += '</div>';
            
            return html;
        }

        function viewDocumentImage(clientId, side) {
            const client = clients.find(c => c.id === clientId);
            if (!client || !client.compliance || !client.compliance.document) return;
            
            const imageData = side === 'front' ? 
                client.compliance.document.imageFront : 
                client.compliance.document.imageBack;
                
            if (!imageData) return;
            
            // Apri l'immagine in una nuova finestra
            const win = window.open('', '_blank');
            win.document.write(`
                <html>
                <head>
                    <title>Documento ${client.name} - ${side === 'front' ? 'Fronte' : 'Retro'}</title>
                    <style>
                        body { margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #000; }
                        img { max-width: 90%; max-height: 90vh; }
                    </style>
                </head>
                <body>
                    <img src="${imageData}" alt="Documento">
                </body>
                </html>
            `);
        }

        // Products
        function openProductModal() {
            document.getElementById('productForm').reset();
            document.getElementById('productDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('productModal').style.display = 'block';
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        function saveProduct(event) {
            event.preventDefault();
            const client = clients.find(c => c.id === currentClientId);
            if (!client.products) client.products = [];
            
            const product = {
                id: Date.now().toString(),
                name: document.getElementById('productName').value,
                type: document.getElementById('productType').value,
                subscriptionDate: document.getElementById('productDate').value,
                initialValue: parseFloat(document.getElementById('productValue').value),
                currentValue: parseFloat(document.getElementById('productValue').value), // Inizialmente uguale
                movements: [],
                valuations: []
            };
            
            client.products.push(product);
            saveData();
            showClientDetail(currentClientId);
            closeProductModal();
            showNotification('Prodotto aggiunto!');
        }

        function deleteProduct(productId) {
            const client = clients.find(c => c.id === currentClientId);
            client.products = client.products.filter(p => p.id !== productId);
            saveData();
            showClientDetail(currentClientId);
        }

        function renderProducts(client) {
            if (!client.products || client.products.length === 0) {
                return '<p style="color: #999; text-align: center;">Nessun prodotto</p>';
            }
            
            // Per compatibilità con vecchi dati
            const total = client.products.reduce((sum, p) => {
                // Se è un prodotto vecchio formato, usa 'value', altrimenti 'currentValue'
                const value = p.currentValue !== undefined ? p.currentValue : (p.value || 0);
                return sum + value;
            }, 0);
            
            return `
                <div style="background: #e0e7ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>Valore Totale Portfolio: € ${total.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong>
                </div>
                ${client.products.map(p => {
                    // Compatibilità con vecchio formato
                    const initialValue = p.initialValue !== undefined ? p.initialValue : (p.value || 0);
                    const currentValue = p.currentValue !== undefined ? p.currentValue : (p.value || 0);
                    const subscriptionDate = p.subscriptionDate ? new Date(p.subscriptionDate).toLocaleDateString('it-IT') : 'N/D';
                    
                    // Calcola il valore totale investito (iniziale + versamenti - disinvestimenti)
                    let totalInvested = initialValue;
                    if (p.movements) {
                        p.movements.forEach(m => {
                            if (m.type === 'versamento') {
                                totalInvested += m.amount;
                            } else if (m.type === 'disinvestimento') {
                                totalInvested -= m.amount;
                            }
                        });
                    }
                    
                    // La performance si calcola solo se c'è una valorizzazione
                    let performanceDisplay = '';
                    let performanceValue = 0;
                    let performanceEuro = 0;
                    
                    // Se c'è almeno una valorizzazione, usa l'ultima
                    if (p.valuations && p.valuations.length > 0) {
                        const lastValuation = p.valuations.sort((a, b) => b.year - a.year)[0];
                        performanceValue = lastValuation.performance;
                        
                        // Calcola la performance in euro
                        const referenceValue = calculateReferenceValue(p, lastValuation.year);
                        performanceEuro = lastValuation.amount - referenceValue;
                        
                        const performanceColor = performanceValue >= 0 ? '#10b981' : '#ef4444';
                        performanceDisplay = `
                            <div>
                                <div style="color: #666; font-size: 12px;">Performance ${lastValuation.year}</div>
                                <div style="font-weight: 600; color: ${performanceColor};">
                                    ${performanceValue >= 0 ? '+' : ''}${performanceValue.toFixed(2)}%
                                </div>
                                <div style="font-size: 14px; color: ${performanceColor};">
                                    ${performanceEuro >= 0 ? '+' : ''}€ ${performanceEuro.toLocaleString('it-IT', {minimumFractionDigits: 2})}
                                </div>
                            </div>
                        `;
                    } else {
                        performanceDisplay = `
                            <div>
                                <div style="color: #666; font-size: 12px;">Performance</div>
                                <div style="font-weight: 600; color: #999;">
                                    N/D
                                </div>
                            </div>
                        `;
                    }
                    
                    return `
                        <div style="margin: 10px 0; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <strong style="font-size: 16px;">${p.name}</strong>
                                        <span class="product-type-badge type-${p.type}">${p.type}</span>
                                    </div>
                                    <div style="margin-top: 8px; color: #666; font-size: 14px;">
                                        <span>Sottoscritto il: ${subscriptionDate}</span>
                                        ${p.movements && p.movements.length > 0 ? `<span style="margin-left: 15px;">• ${p.movements.length} movimenti</span>` : ''}
                                        ${p.valuations && p.valuations.length > 0 ? `<span style="margin-left: 15px;">• ${p.valuations.length} valorizzazioni</span>` : ''}
                                    </div>
                                    <div style="margin-top: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                                        <div>
                                            <div style="color: #666; font-size: 12px;">Valore Iniziale</div>
                                            <div style="font-weight: 600;">€ ${initialValue.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                                        </div>
                                        <div>
                                            <div style="color: #666; font-size: 12px;">Totale Investito</div>
                                            <div style="font-weight: 600;">€ ${totalInvested.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                                        </div>
                                        <div>
                                            <div style="color: #666; font-size: 12px;">Valore Attuale</div>
                                            <div style="font-weight: 600;">€ ${currentValue.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                                        </div>
                                        ${performanceDisplay}
                                    </div>
                                    ${renderProductTimeline(p)}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <button class="btn btn-secondary btn-small" onclick="openMovementModal('${p.id}')">
                                        + Movimento
                                    </button>
                                    <button class="btn btn-secondary btn-small" onclick="openValuationModal('${p.id}')">
                                        + Valorizzazione
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="deleteProduct('${p.id}')">
                                        Elimina
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function renderProductTimeline(product) {
            const events = [];
            
            // Aggiungi movimenti
            if (product.movements) {
                product.movements.forEach(m => {
                    events.push({
                        date: new Date(m.date),
                        type: 'movement',
                        data: m
                    });
                });
            }
            
            // Aggiungi valorizzazioni
            if (product.valuations) {
                product.valuations.forEach(v => {
                    events.push({
                        date: new Date(`${v.year}-12-31`),
                        type: 'valuation',
                        data: v
                    });
                });
            }
            
            // Ordina per data
            events.sort((a, b) => b.date - a.date);
            
            if (events.length === 0) return '';
            
            return `
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <details>
                        <summary style="cursor: pointer; font-weight: 500; color: #374151;">
                            📊 Storico Movimenti e Valorizzazioni
                        </summary>
                        <div style="margin-top: 10px; max-height: 200px; overflow-y: auto;">
                            ${events.map(event => {
                                if (event.type === 'movement') {
                                    const m = event.data;
                                    const icon = m.type === 'versamento' ? '📈' : m.type === 'disinvestimento' ? '📉' : '🔄';
                                    const color = m.type === 'versamento' ? '#10b981' : m.type === 'disinvestimento' ? '#ef4444' : '#3b82f6';
                                    const sign = m.type === 'versamento' ? '+' : m.type === 'disinvestimento' ? '-' : '';
                                    
                                    return `
                                        <div style="padding: 8px; margin: 5px 0; background: #f9fafb; border-radius: 6px; border-left: 3px solid ${color};">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div style="flex: 1;">
                                                    <span>${icon}</span>
                                                    <strong style="margin-left: 8px;">${m.type.charAt(0).toUpperCase() + m.type.slice(1)}</strong>
                                                    <span style="color: #666; margin-left: 10px;">${event.date.toLocaleDateString('it-IT')}</span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <strong style="color: ${color};">
                                                        ${sign}€ ${m.amount.toLocaleString('it-IT', {minimumFractionDigits: 2})}
                                                    </strong>
                                                    <div style="display: flex; gap: 5px;">
                                                        <button class="btn btn-secondary btn-small" style="padding: 4px 8px; font-size: 12px;" onclick="editMovement('${product.id}', '${m.id}')">
                                                            ✏️
                                                        </button>
                                                        <button class="btn btn-danger btn-small" style="padding: 4px 8px; font-size: 12px;" onclick="deleteMovement('${product.id}', '${m.id}')">
                                                            🗑️
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            ${m.notes ? `<div style="color: #666; font-size: 12px; margin-top: 4px;">${m.notes}</div>` : ''}
                                        </div>
                                    `;
                                } else {
                                    const v = event.data;
                                    const performanceColor = v.performance >= 0 ? '#10b981' : '#ef4444';
                                    
                                    // Calcola la performance in euro
                                    const referenceValue = calculateReferenceValue(product, v.year);
                                    const performanceEuro = v.amount - referenceValue;
                                    
                                    return `
                                        <div style="padding: 8px; margin: 5px 0; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <span>📊</span>
                                                    <strong style="margin-left: 8px;">Valorizzazione ${v.year}</strong>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <div style="text-align: right;">
                                                        <div>€ ${v.amount.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                                                        <div style="color: ${performanceColor}; font-size: 12px;">
                                                            ${v.performance >= 0 ? '+' : ''}${v.performance.toFixed(2)}%
                                                            (${performanceEuro >= 0 ? '+' : ''}€ ${performanceEuro.toLocaleString('it-IT', {minimumFractionDigits: 2})})
                                                        </div>
                                                    </div>
                                                    <div style="display: flex; gap: 5px;">
                                                        <button class="btn btn-secondary btn-small" style="padding: 4px 8px; font-size: 12px;" onclick="editValuation('${product.id}', '${v.id}')">
                                                            ✏️
                                                        </button>
                                                        <button class="btn btn-danger btn-small" style="padding: 4px 8px; font-size: 12px;" onclick="deleteValuation('${product.id}', '${v.id}')">
                                                            🗑️
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            ${v.notes ? `<div style="color: #666; font-size: 12px; margin-top: 4px;">${v.notes}</div>` : ''}
                                        </div>
                                    `;
                                }
                            }).join('')}
                        </div>
                    </details>
                </div>
            `;
        }

        // Product Movements and Valuations Functions
        let currentProductId = null;
        let currentMovementId = null;
        let currentValuationId = null;

        function openMovementModal(productId, movementId = null) {
            currentProductId = productId;
            currentMovementId = movementId;
            
            document.getElementById('movementForm').reset();
            
            if (movementId) {
                // Modalità modifica
                const client = clients.find(c => c.id === currentClientId);
                const product = client.products.find(p => p.id === productId);
                const movement = product.movements.find(m => m.id === movementId);
                
                document.getElementById('movementType').value = movement.type;
                document.getElementById('movementDate').value = movement.date;
                document.getElementById('movementAmount').value = movement.amount;
                document.getElementById('movementNotes').value = movement.notes || '';
                updateMovementLabel();
            } else {
                // Modalità nuovo
                document.getElementById('movementDate').value = new Date().toISOString().split('T')[0];
            }
            
            document.getElementById('movementModal').style.display = 'block';
        }

        function closeMovementModal() {
            document.getElementById('movementModal').style.display = 'none';
            currentProductId = null;
            currentMovementId = null;
        }

        function updateMovementLabel() {
            const type = document.getElementById('movementType').value;
            const label = document.getElementById('movementAmountLabel');
            const help = document.getElementById('movementAmountHelp');
            
            switch(type) {
                case 'versamento':
                    label.textContent = 'Importo Versamento (€) *';
                    help.textContent = 'Importo che verrà aggiunto al prodotto';
                    break;
                case 'disinvestimento':
                    label.textContent = 'Importo Disinvestimento (€) *';
                    help.textContent = 'Importo che verrà sottratto dal prodotto';
                    break;
                case 'switch':
                    label.textContent = 'Importo Switch (€) *';
                    help.textContent = 'Importo coinvolto nel cambio linea';
                    break;
            }
        }

        function saveMovement(event) {
            event.preventDefault();
            const client = clients.find(c => c.id === currentClientId);
            const product = client.products.find(p => p.id === currentProductId);
            
            if (!product.movements) product.movements = [];
            
            const movementData = {
                type: document.getElementById('movementType').value,
                date: document.getElementById('movementDate').value,
                amount: parseFloat(document.getElementById('movementAmount').value),
                notes: document.getElementById('movementNotes').value
            };
            
            if (currentMovementId) {
                // Modifica movimento esistente
                const movementIndex = product.movements.findIndex(m => m.id === currentMovementId);
                product.movements[movementIndex] = {
                    ...product.movements[movementIndex],
                    ...movementData
                };
            } else {
                // Nuovo movimento
                const movement = {
                    id: Date.now().toString(),
                    ...movementData
                };
                product.movements.push(movement);
            }
            
            // Aggiorna il valore corrente
            updateProductCurrentValue(product);
            
            saveData();
            showClientDetail(currentClientId);
            closeMovementModal();
            showNotification(currentMovementId ? 'Movimento modificato!' : 'Movimento registrato!');
        }
        
        function editMovement(productId, movementId) {
            openMovementModal(productId, movementId);
        }
        
        function deleteMovement(productId, movementId) {
            if (confirm('Eliminare questo movimento?')) {
                const client = clients.find(c => c.id === currentClientId);
                const product = client.products.find(p => p.id === productId);
                product.movements = product.movements.filter(m => m.id !== movementId);
                
                updateProductCurrentValue(product);
                saveData();
                showClientDetail(currentClientId);
                showNotification('Movimento eliminato');
            }
        }

        function openValuationModal(productId) {
            currentProductId = productId;
            const client = clients.find(c => c.id === currentClientId);
            const product = client.products.find(p => p.id === currentProductId);
            
            document.getElementById('valuationForm').reset();
            
            // Genera anni disponibili
            const yearSelect = document.getElementById('valuationYear');
            yearSelect.innerHTML = '';
            
            const startYear = new Date(product.subscriptionDate).getFullYear();
            const currentYear = new Date().getFullYear();
            
            for (let year = startYear; year <= currentYear; year++) {
                // Controlla se esiste già una valorizzazione per questo anno
                const existingValuation = product.valuations?.find(v => v.year === year);
                if (!existingValuation) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                }
            }
            
            if (yearSelect.options.length === 0) {
                alert('Hai già inserito le valorizzazioni per tutti gli anni disponibili');
                return;
            }
            
            document.getElementById('valuationModal').style.display = 'block';
        }

        function closeValuationModal() {
            document.getElementById('valuationModal').style.display = 'none';
            currentProductId = null;
            currentValuationId = null;
        }

        function saveValuation(event) {
            event.preventDefault();
            const client = clients.find(c => c.id === currentClientId);
            const product = client.products.find(p => p.id === currentProductId);
            
            if (!product.valuations) product.valuations = [];
            
            const year = parseInt(document.getElementById('valuationYear').value);
            const amount = parseFloat(document.getElementById('valuationAmount').value);
            
            // Calcola il valore di riferimento per il calcolo performance
            const referenceValue = calculateReferenceValue(product, year);
            const performance = ((amount - referenceValue) / referenceValue) * 100;
            
            const valuationData = {
                year: year,
                amount: amount,
                performance: performance,
                notes: document.getElementById('valuationNotes').value,
                date: new Date().toISOString()
            };
            
            if (currentValuationId) {
                // Modifica valorizzazione esistente
                const valuationIndex = product.valuations.findIndex(v => v.id === currentValuationId);
                product.valuations[valuationIndex] = {
                    ...product.valuations[valuationIndex],
                    ...valuationData
                };
            } else {
                // Nuova valorizzazione
                const valuation = {
                    id: Date.now().toString(),
                    ...valuationData
                };
                product.valuations.push(valuation);
            }
            
            // Aggiorna il valore corrente se è l'ultimo anno
            if (year === new Date().getFullYear()) {
                product.currentValue = amount;
            }
            
            saveData();
            showClientDetail(currentClientId);
            closeValuationModal();
            showNotification(currentValuationId ? 'Valorizzazione modificata!' : 'Valorizzazione registrata!');
        }
        
        function editValuation(productId, valuationId) {
            openValuationModal(productId, valuationId);
        }
        
        function deleteValuation(productId, valuationId) {
            if (confirm('Eliminare questa valorizzazione?')) {
                const client = clients.find(c => c.id === currentClientId);
                const product = client.products.find(p => p.id === productId);
                product.valuations = product.valuations.filter(v => v.id !== valuationId);
                
                // Ricalcola il valore corrente
                updateProductCurrentValue(product);
                saveData();
                showClientDetail(currentClientId);
                showNotification('Valorizzazione eliminata');
            }
        }

        function updateProductCurrentValue(product) {
            let value = product.initialValue;
            
            // Applica tutti i movimenti
            if (product.movements) {
                product.movements.forEach(movement => {
                    if (movement.type === 'versamento') {
                        value += movement.amount;
                    } else if (movement.type === 'disinvestimento') {
                        value -= movement.amount;
                    }
                });
            }
            
            // Se c'è una valorizzazione per l'anno corrente, usa quella
            const currentYear = new Date().getFullYear();
            const currentValuation = product.valuations?.find(v => v.year === currentYear);
            if (currentValuation) {
                value = currentValuation.amount;
            }
            
            product.currentValue = value;
        }

        function calculateReferenceValue(product, year) {
            let value = product.initialValue;
            
            // Aggiungi TUTTI i movimenti fino alla fine dell'anno per cui si sta calcolando
            if (product.movements) {
                product.movements
                    .filter(m => new Date(m.date).getFullYear() <= year)
                    .forEach(movement => {
                        if (movement.type === 'versamento') {
                            value += movement.amount;
                        } else if (movement.type === 'disinvestimento') {
                            value -= movement.amount;
                        }
                    });
            }
            
            return value;
        }

        // Update valuationAmount change event
        document.addEventListener('DOMContentLoaded', function() {
            const valuationAmountInput = document.getElementById('valuationAmount');
            if (valuationAmountInput) {
                valuationAmountInput.addEventListener('input', function() {
                    if (currentProductId) {
                        const client = clients.find(c => c.id === currentClientId);
                        const product = client.products.find(p => p.id === currentProductId);
                        const year = parseInt(document.getElementById('valuationYear').value);
                        const amount = parseFloat(this.value) || 0;
                        
                        const referenceValue = calculateReferenceValue(product, year);
                        const performance = referenceValue > 0 ? ((amount - referenceValue) / referenceValue) * 100 : 0;
                        
                        document.getElementById('valuationPerformance').value = performance.toFixed(2);
                    }
                });
            }
        });

        // Meetings
        function openMeetingModal() {
            document.getElementById('meetingForm').reset();
            document.getElementById('meetingDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('meetingModal').style.display = 'block';
        }

        function closeMeetingModal() {
            document.getElementById('meetingModal').style.display = 'none';
        }

        function saveMeeting(event) {
            event.preventDefault();
            const client = clients.find(c => c.id === currentClientId);
            if (!client.meetings) client.meetings = [];
            client.meetings.push({
                id: Date.now().toString(),
                date: document.getElementById('meetingDate').value,
                notes: document.getElementById('meetingNotes').value
            });
            saveData();
            showClientDetail(currentClientId);
            closeMeetingModal();
            showNotification('Incontro aggiunto!');
        }

        function deleteMeeting(meetingId) {
            const client = clients.find(c => c.id === currentClientId);
            client.meetings = client.meetings.filter(m => m.id !== meetingId);
            saveData();
            showClientDetail(currentClientId);
        }

        function renderMeetings(client) {
            if (!client.meetings || client.meetings.length === 0) {
                return '<p style="color: #999; text-align: center;">Nessun incontro</p>';
            }
            return client.meetings
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(m => `
                    <div style="margin: 10px 0; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong style="color: var(--primary);">${new Date(m.date).toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</strong>
                                <div style="margin-top: 5px; color: #666;">${m.notes}</div>
                            </div>
                            <button class="btn btn-danger btn-small" onclick="deleteMeeting('${m.id}')">Elimina</button>
                        </div>
                    </div>
                `).join('');
        }

        // Documents
        function openDocumentModal() {
            document.getElementById('documentForm').reset();
            document.getElementById('documentModal').style.display = 'block';
        }

        function closeDocumentModal() {
            document.getElementById('documentModal').style.display = 'none';
        }

        function saveDocument(event) {
            event.preventDefault();
            const file = document.getElementById('documentFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const client = clients.find(c => c.id === currentClientId);
                if (!client.documents) client.documents = [];
                client.documents.push({
                    id: Date.now().toString(),
                    name: file.name,
                    desc: document.getElementById('documentDesc').value || 'Documento',
                    data: e.target.result,
                    size: file.size,
                    type: file.type,
                    date: new Date().toISOString()
                });
                saveData();
                showClientDetail(currentClientId);
                closeDocumentModal();
                showNotification('Documento caricato!');
            };
            reader.readAsDataURL(file);
        }

        function deleteDocument(docId) {
            const client = clients.find(c => c.id === currentClientId);
            client.documents = client.documents.filter(d => d.id !== docId);
            saveData();
            showClientDetail(currentClientId);
        }

        function downloadDocument(docId) {
            const client = clients.find(c => c.id === currentClientId);
            const doc = client.documents.find(d => d.id === docId);
            const link = document.createElement('a');
            link.href = doc.data;
            link.download = doc.name;
            link.click();
        }

        function renderDocuments(client) {
            if (!client.documents || client.documents.length === 0) {
                return '<p style="color: #999; text-align: center;">Nessun documento</p>';
            }
            return client.documents.map(d => `
                <div style="margin: 10px 0; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${d.name}</strong>
                            <div style="margin-top: 5px; color: #666;">${d.desc} • ${formatFileSize(d.size)} • ${new Date(d.date).toLocaleDateString('it-IT')}</div>
                        </div>
                        <div>
                            <button class="btn btn-secondary btn-small" onclick="downloadDocument('${d.id}')">Scarica</button>
                            <button class="btn btn-danger btn-small" onclick="deleteDocument('${d.id}')">Elimina</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Advanced Filters Functions
        let activeFilters = {
            cliente: {},
            prospect: {},
            all: {}
        };

        function initializeFilters() {
            ['cliente', 'prospect', 'all'].forEach(type => {
                const filterPanel = document.getElementById(`filters-${type}`);
                if (filterPanel) {
                    filterPanel.innerHTML = generateFilterHTML(type);
                }
            });
        }

        function generateFilterHTML(type) {
            // Ottieni valori unici per i select
            const cities = [...new Set(clients.filter(c => c.city).map(c => c.city))].sort();
            const provinces = [...new Set(clients.filter(c => c.province).map(c => c.province))].sort();
            const zips = [...new Set(clients.filter(c => c.zip).map(c => c.zip))].sort();
            
            return `
                <div class="filter-group">
                    <div class="filter-item">
                        <label>Città</label>
                        <select id="filter-city-${type}" onchange="applyFilter('${type}', 'city', this.value)">
                            <option value="">Tutte le città</option>
                            ${cities.map(city => `<option value="${city}">${city}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label>Provincia</label>
                        <select id="filter-province-${type}" onchange="applyFilter('${type}', 'province', this.value)">
                            <option value="">Tutte le province</option>
                            ${provinces.map(prov => `<option value="${prov}">${prov}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label>CAP</label>
                        <select id="filter-zip-${type}" onchange="applyFilter('${type}', 'zip', this.value)">
                            <option value="">Tutti i CAP</option>
                            ${zips.map(zip => `<option value="${zip}">${zip}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label>Profilo MIFID</label>
                        <select id="filter-mifid-${type}" onchange="applyFilter('${type}', 'mifid', this.value)">
                            <option value="">Tutti i profili</option>
                            <option value="Conservativo">Conservativo</option>
                            <option value="Moderato">Moderato</option>
                            <option value="Dinamico">Dinamico</option>
                            <option value="Attivo">Attivo</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label>Flusso Telefonico</label>
                        <select id="filter-phoneFlow-${type}" onchange="applyFilter('${type}', 'phoneFlow', this.value)">
                            <option value="">Tutti</option>
                            <option value="certificato">Numero Certificato</option>
                            <option value="non_certificato">Numero Non Certificato</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label>My Key</label>
                        <select id="filter-myKey-${type}" onchange="applyFilter('${type}', 'myKey', this.value)">
                            <option value="">Tutti</option>
                            <option value="MYKEY_SMART">MyKey Smart</option>
                            <option value="MYKEY_SMS">MyKey SMS</option>
                            <option value="NESSUN_MYKEY">Nessun MyKey</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label>Servizi Online</label>
                        <select id="filter-onlineServices-${type}" onchange="applyFilter('${type}', 'onlineServices', this.value)">
                            <option value="">Tutti</option>
                            <option value="SI">SI</option>
                            <option value="NO">NO</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label>Generazione</label>
                        <select id="filter-generation-${type}" onchange="applyFilter('${type}', 'generation', this.value)">
                            <option value="">Tutte le generazioni</option>
                            <option value="tradizionalisti">Tradizionalisti</option>
                            <option value="baby_boomers">Baby Boomers</option>
                            <option value="generazione_x">Generazione X</option>
                            <option value="millennials">Millennials</option>
                            <option value="generazione_z">Generazione Z</option>
                            <option value="generazione_alpha">Generazione Alpha</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label>Valore Portfolio</label>
                        <select id="filter-portfolio-${type}" onchange="applyFilter('${type}', 'portfolio', this.value)">
                            <option value="">Tutti</option>
                            <option value="0">Senza prodotti</option>
                            <option value="1-10000">1 - 10.000 €</option>
                            <option value="10001-50000">10.001 - 50.000 €</option>
                            <option value="50001-100000">50.001 - 100.000 €</option>
                            <option value="100001+">Oltre 100.000 €</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label>Ultimo Incontro</label>
                        <select id="filter-lastMeeting-${type}" onchange="applyFilter('${type}', 'lastMeeting', this.value)">
                            <option value="">Tutti</option>
                            <option value="never">Mai incontrato</option>
                            <option value="30">Ultimi 30 giorni</option>
                            <option value="90">Ultimi 90 giorni</option>
                            <option value="180">Ultimi 6 mesi</option>
                            <option value="365">Ultimo anno</option>
                            <option value="365+">Oltre un anno</option>
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label>Numero Prodotti</label>
                        <select id="filter-productsCount-${type}" onchange="applyFilter('${type}', 'productsCount', this.value)">
                            <option value="">Tutti</option>
                            <option value="0">Nessun prodotto</option>
                            <option value="1">1 prodotto</option>
                            <option value="2">2 prodotti</option>
                            <option value="3+">3+ prodotti</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <button class="btn btn-secondary btn-small" onclick="clearAllFilters('${type}')">
                        Rimuovi tutti i filtri
                    </button>
                    <button class="btn btn-primary btn-small" onclick="exportFiltered('${type}')">
                        📤 Esporta risultati filtrati
                    </button>
                </div>
                
                <div id="active-filters-${type}" class="active-filters"></div>
            `;
        }

        function toggleFilters(type) {
            const filterPanel = document.getElementById(`filters-${type}`);
            filterPanel.style.display = filterPanel.style.display === 'none' ? 'block' : 'none';
        }

        function applyFilter(type, filterKey, value) {
            if (value) {
                activeFilters[type][filterKey] = value;
            } else {
                delete activeFilters[type][filterKey];
            }
            
            updateActiveFilterTags(type);
            applyAllFilters(type);
        }

        function updateActiveFilterTags(type) {
            const container = document.getElementById(`active-filters-${type}`);
            const filters = activeFilters[type];
            
            const tags = Object.entries(filters).map(([key, value]) => {
                let label = '';
                switch(key) {
                    case 'city': label = `Città: ${value}`; break;
                    case 'province': label = `Provincia: ${value}`; break;
                    case 'zip': label = `CAP: ${value}`; break;
                    case 'mifid': label = `MIFID: ${value}`; break;
                    case 'phoneFlow': label = `Tel: ${value === 'certificato' ? 'Certificato' : 'Non Certificato'}`; break;
                    case 'myKey': label = `MyKey: ${value.replace(/_/g, ' ')}`; break;
                    case 'onlineServices': label = `Servizi Online: ${value}`; break;
                    case 'generation': label = `Generazione: ${getGenerationLabel(value)}`; break;
                    case 'portfolio': label = `Portfolio: ${value}`; break;
                    case 'lastMeeting': label = `Ultimo Incontro: ${value}`; break;
                    case 'productsCount': label = `Prodotti: ${value}`; break;
                }
                
                return `
                    <span class="filter-tag">
                        ${label}
                        <button onclick="removeFilter('${type}', '${key}')">×</button>
                    </span>
                `;
            }).join('');
            
            container.innerHTML = tags;
        }

        function removeFilter(type, filterKey) {
            delete activeFilters[type][filterKey];
            document.getElementById(`filter-${filterKey}-${type}`).value = '';
            updateActiveFilterTags(type);
            applyAllFilters(type);
        }

        function clearAllFilters(type) {
            activeFilters[type] = {};
            
            // Reset all selects
            const filterPanel = document.getElementById(`filters-${type}`);
            filterPanel.querySelectorAll('select').forEach(select => {
                select.value = '';
            });
            
            updateActiveFilterTags(type);
            applyAllFilters(type);
        }

        function applyAllFilters(type) {
            let filtered = clients;
            
            // Filtra per tipo se necessario
            if (type === 'cliente') {
                filtered = filtered.filter(c => c.type === 'cliente');
            } else if (type === 'prospect') {
                filtered = filtered.filter(c => c.type === 'prospect');
            }
            
            // Applica filtri attivi
            Object.entries(activeFilters[type]).forEach(([key, value]) => {
                switch(key) {
                    case 'city':
                        filtered = filtered.filter(c => c.city === value);
                        break;
                    case 'province':
                        filtered = filtered.filter(c => c.province === value);
                        break;
                    case 'zip':
                        filtered = filtered.filter(c => c.zip === value);
                        break;
                    case 'mifid':
                        filtered = filtered.filter(c => c.mifid === value);
                        break;
                    case 'phoneFlow':
                        filtered = filtered.filter(c => c.phoneFlow === value);
                        break;
                    case 'myKey':
                        filtered = filtered.filter(c => c.myKey === value);
                        break;
                    case 'onlineServices':
                        filtered = filtered.filter(c => c.onlineServices === value);
                        break;
                    case 'generation':
                        filtered = filtered.filter(c => {
                            const clientGen = c.generation || calculateGeneration(c.birthDate);
                            return clientGen === value;
                        });
                        break;
                    case 'portfolio':
                        filtered = filtered.filter(c => {
                            const total = (c.products || []).reduce((sum, p) => sum + p.value, 0);
                            if (value === '0') return total === 0;
                            if (value === '1-10000') return total >= 1 && total <= 10000;
                            if (value === '10001-50000') return total >= 10001 && total <= 50000;
                            if (value === '50001-100000') return total >= 50001 && total <= 100000;
                            if (value === '100001+') return total > 100000;
                            return true;
                        });
                        break;
                    case 'lastMeeting':
                        filtered = filtered.filter(c => {
                            if (value === 'never') return !c.meetings || c.meetings.length === 0;
                            
                            if (c.meetings && c.meetings.length > 0) {
                                const lastMeeting = new Date(Math.max(...c.meetings.map(m => new Date(m.date))));
                                const daysSince = (new Date() - lastMeeting) / (1000 * 60 * 60 * 24);
                                
                                if (value === '30') return daysSince <= 30;
                                if (value === '90') return daysSince <= 90;
                                if (value === '180') return daysSince <= 180;
                                if (value === '365') return daysSince <= 365;
                                if (value === '365+') return daysSince > 365;
                            }
                            return false;
                        });
                        break;
                    case 'productsCount':
                        filtered = filtered.filter(c => {
                            const count = (c.products || []).length;
                            if (value === '0') return count === 0;
                            if (value === '1') return count === 1;
                            if (value === '2') return count === 2;
                            if (value === '3+') return count >= 3;
                            return true;
                        });
                        break;
                }
            });
            
            // Applica anche la ricerca testuale se presente
            const searchBox = document.querySelector(`#${type}-tab .search-box`);
            if (searchBox && searchBox.value) {
                const searchTerm = searchBox.value.toLowerCase();
                filtered = filtered.filter(c => {
                    return c.name.toLowerCase().includes(searchTerm) ||
                           (c.email && c.email.toLowerCase().includes(searchTerm)) ||
                           (c.phone && c.phone.includes(searchTerm)) ||
                           (c.cf && c.cf.toLowerCase().includes(searchTerm));
                });
            }
            
            // Renderizza i risultati
            const listId = type === 'cliente' ? 'clients-list' : 
                          type === 'prospect' ? 'prospects-list' : 'all-list';
            renderClientsList(filtered, listId);
            
            // Mostra conteggio risultati
            showFilteredCount(type, filtered.length);
        }

        function showFilteredCount(type, count) {
            const filterPanel = document.getElementById(`filters-${type}`);
            if (Object.keys(activeFilters[type]).length > 0) {
                const existingCount = filterPanel.querySelector('.filtered-count');
                if (existingCount) {
                    existingCount.textContent = `Trovati ${count} risultati`;
                } else {
                    const countDiv = document.createElement('div');
                    countDiv.className = 'filtered-count';
                    countDiv.style.cssText = 'background: #d1fae5; color: #065f46; padding: 10px; border-radius: 6px; margin-top: 10px; text-align: center; font-weight: 500;';
                    countDiv.textContent = `Trovati ${count} risultati`;
                    filterPanel.appendChild(countDiv);
                }
            } else {
                const existingCount = filterPanel.querySelector('.filtered-count');
                if (existingCount) existingCount.remove();
            }
        }

        function exportFiltered(type) {
            let filtered = clients;
            
            // Applica gli stessi filtri
            if (type === 'cliente') {
                filtered = filtered.filter(c => c.type === 'cliente');
            } else if (type === 'prospect') {
                filtered = filtered.filter(c => c.type === 'prospect');
            }
            
            Object.entries(activeFilters[type]).forEach(([key, value]) => {
                switch(key) {
                    case 'city':
                        filtered = filtered.filter(c => c.city === value);
                        break;
                    case 'province':
                        filtered = filtered.filter(c => c.province === value);
                        break;
                    case 'zip':
                        filtered = filtered.filter(c => c.zip === value);
                        break;
                    case 'mifid':
                        filtered = filtered.filter(c => c.mifid === value);
                        break;
                    case 'phoneFlow':
                        filtered = filtered.filter(c => c.phoneFlow === value);
                        break;
                    case 'myKey':
                        filtered = filtered.filter(c => c.myKey === value);
                        break;
                    case 'onlineServices':
                        filtered = filtered.filter(c => c.onlineServices === value);
                        break;
                    case 'generation':
                        filtered = filtered.filter(c => {
                            const clientGen = c.generation || calculateGeneration(c.birthDate);
                            return clientGen === value;
                        });
                        break;
                    case 'portfolio':
                        filtered = filtered.filter(c => {
                            const total = (c.products || []).reduce((sum, p) => {
                                const value = p.currentValue !== undefined ? p.currentValue : (p.value || 0);
                                return sum + value;
                            }, 0);
                            if (value === '0') return total === 0;
                            if (value === '1-10000') return total >= 1 && total <= 10000;
                            if (value === '10001-50000') return total >= 10001 && total <= 50000;
                            if (value === '50001-100000') return total >= 50001 && total <= 100000;
                            if (value === '100001+') return total > 100000;
                            return true;
                        });
                        break;
                    case 'lastMeeting':
                        filtered = filtered.filter(c => {
                            if (value === 'never') return !c.meetings || c.meetings.length === 0;
                            
                            if (c.meetings && c.meetings.length > 0) {
                                const lastMeeting = new Date(Math.max(...c.meetings.map(m => new Date(m.date))));
                                const daysSince = (new Date() - lastMeeting) / (1000 * 60 * 60 * 24);
                                
                                if (value === '30') return daysSince <= 30;
                                if (value === '90') return daysSince <= 90;
                                if (value === '180') return daysSince <= 180;
                                if (value === '365') return daysSince <= 365;
                                if (value === '365+') return daysSince > 365;
                            }
                            return false;
                        });
                        break;
                    case 'productsCount':
                        filtered = filtered.filter(c => {
                            const count = (c.products || []).length;
                            if (value === '0') return count === 0;
                            if (value === '1') return count === 1;
                            if (value === '2') return count === 2;
                            if (value === '3+') return count >= 3;
                            return true;
                        });
                        break;
                }
            });
            
            // Esporta i risultati filtrati
            exportFilteredToExcel(filtered, type);
        }

        function exportFilteredToExcel(filteredClients, type) {
            let csv = '\ufeff';
            csv += 'Nominativo Cliente,Data di Nascita,Generazione,Codice Fiscale,Indirizzo,Numero Civico,Comune,CAP,Provincia,Telefono,Flusso Telefonico,Email,Servizi Online,My Key,Profilo MIFID,Tipo,Note,Numero Prodotti,Valore Portfolio,Numero Incontri,Numero Documenti\n';
            
            filteredClients.forEach(client => {
                const totalValue = client.products ? client.products.reduce((sum, p) => {
                    const value = p.currentValue !== undefined ? p.currentValue : (p.value || 0);
                    return sum + value;
                }, 0) : 0;
                const birthDateFormatted = client.birthDate ? 
                    new Date(client.birthDate).toLocaleDateString('it-IT') : '';
                const generation = getGenerationLabel(client.generation || calculateGeneration(client.birthDate));
                
                const row = [
                    client.name,
                    birthDateFormatted,
                    generation,
                    client.cf || '',
                    client.address || '',
                    client.civic || '',
                    client.city || '',
                    client.zip || '',
                    client.province || '',
                    client.phone || '',
                    client.phoneFlow || '',
                    client.email || '',
                    client.onlineServices || '',
                    client.myKey || '',
                    client.mifid || '',
                    client.type,
                    client.notes ? client.notes.replace(/,/g, ';') : '',
                    client.products ? client.products.length : 0,
                    totalValue,
                    client.meetings ? client.meetings.length : 0,
                    client.documents ? client.documents.length : 0
                ].join(',');
                csv += row + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `esportazione_filtrata_${type}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showNotification(`Esportati ${filteredClients.length} contatti filtrati!`);
        }

        // Search
        function searchClients(term, type) {
            // Se ci sono filtri attivi, riapplica tutto
            if (Object.keys(activeFilters[type]).length > 0) {
                applyAllFilters(type);
            } else {
                // Altrimenti usa la ricerca semplice originale
                const filtered = clients.filter(c => {
                    const matches = c.name.toLowerCase().includes(term.toLowerCase()) ||
                                  (c.email && c.email.toLowerCase().includes(term.toLowerCase())) ||
                                  (c.phone && c.phone.includes(term)) ||
                                  (c.cf && c.cf.toLowerCase().includes(term.toLowerCase()));
                    if (type === 'all') return matches;
                    return matches && c.type === type;
                });
                
                if (type === 'cliente') {
                    renderClientsList(filtered.filter(c => c.type === 'cliente'), 'clients-list');
                } else if (type === 'prospect') {
                    renderClientsList(filtered.filter(c => c.type === 'prospect'), 'prospects-list');
                } else {
                    renderClientsList(filtered, 'all-list');
                }
            }
        }

        // Google Maps integration
        function openGoogleMaps(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client && client.address && client.city) {
                const fullAddress = [
                    client.address,
                    client.civic,
                    client.zip,
                    client.city,
                    client.province
                ].filter(Boolean).join(' ');
                
                const encodedAddress = encodeURIComponent(fullAddress);
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodedAddress}`, '_blank');
            }
        }

        // WhatsApp integration
        function openWhatsApp(phone) {
            if (phone) {
                // Remove spaces, dashes, and other non-numeric characters
                let cleanPhone = phone.replace(/[^0-9+]/g, '');
                
                // If the number doesn't start with +, assume it's Italian
                if (!cleanPhone.startsWith('+')) {
                    cleanPhone = '+39' + cleanPhone;
                }
                
                // Open WhatsApp with the phone number
                window.open(`https://wa.me/${cleanPhone}`, '_blank');
            }
        }

        // Birthday Functions
        function openBirthdayModal() {
            checkBirthdays();
            document.getElementById('birthdayModal').style.display = 'block';
        }

        function closeBirthdayModal() {
            document.getElementById('birthdayModal').style.display = 'none';
        }

        function checkBirthdays() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalizza a mezzanotte
            
            const birthdaysToday = [];
            const birthdaysWeek = [];
            const birthdaysMonth = [];
            
            clients.forEach(client => {
                if (!client.birthDate) return;
                
                const birthDate = new Date(client.birthDate);
                const birthDay = birthDate.getDate();
                const birthMonth = birthDate.getMonth();
                
                // Calcola il prossimo compleanno
                let nextBirthday = new Date(today.getFullYear(), birthMonth, birthDay);
                nextBirthday.setHours(0, 0, 0, 0);
                
                // Se il compleanno è già passato quest'anno, prendi quello dell'anno prossimo
                if (nextBirthday < today) {
                    nextBirthday = new Date(today.getFullYear() + 1, birthMonth, birthDay);
                }
                
                // Calcola i giorni fino al compleanno
                const diffTime = nextBirthday - today;
                const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // Calcola l'età che compirà
                let age = nextBirthday.getFullYear() - birthDate.getFullYear();
                
                const birthdayInfo = {
                    client: client,
                    date: nextBirthday,
                    age: age,
                    daysUntil: daysUntil
                };
                
                // Categorizza in base ai giorni
                if (daysUntil === 0) {
                    birthdaysToday.push(birthdayInfo);
                } else if (daysUntil >= 1 && daysUntil <= 7) {
                    birthdaysWeek.push(birthdayInfo);
                } else if (daysUntil > 7 && daysUntil <= 30) {
                    birthdaysMonth.push(birthdayInfo);
                }
            });
            
            // Ordina per data
            birthdaysWeek.sort((a, b) => a.daysUntil - b.daysUntil);
            birthdaysMonth.sort((a, b) => a.daysUntil - b.daysUntil);
            
            // Mostra i risultati
            displayBirthdays(birthdaysToday, birthdaysWeek, birthdaysMonth);
        }

        function displayBirthdays(today, week, month) {
            const todaySection = document.getElementById('birthdayTodaySection');
            const weekSection = document.getElementById('birthdayWeekSection');
            const monthSection = document.getElementById('birthdayMonthSection');
            const noBirthdaysMsg = document.getElementById('noBirthdaysMessage');
            
            // Reset visibility
            todaySection.style.display = 'none';
            weekSection.style.display = 'none';
            monthSection.style.display = 'none';
            noBirthdaysMsg.style.display = 'none';
            
            let hasBirthdays = false;
            
            // Compleanni di oggi
            if (today.length > 0) {
                hasBirthdays = true;
                todaySection.style.display = 'block';
                document.getElementById('birthdaysToday').innerHTML = today.map(b => `
                    <div style="padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="font-size: 18px;">${b.client.name}</strong>
                                <span style="color: #92400e; margin-left: 10px;">compie ${b.age} anni! 🎉</span>
                                ${b.client.phone ? `<div style="color: #666; margin-top: 5px;">📱 ${b.client.phone}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                ${b.client.phone ? `
                                    <button class="btn btn-secondary btn-small" style="background: #25D366;" onclick="sendBirthdayWhatsApp('${b.client.phone}', '${b.client.name}')">
                                        WhatsApp
                                    </button>
                                ` : ''}
                                ${b.client.email ? `
                                    <button class="btn btn-secondary btn-small" style="background: #EA4335;" onclick="sendBirthdayEmail('${b.client.email}', '${b.client.name}')">
                                        Email
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // Compleanni della settimana
            if (week.length > 0) {
                hasBirthdays = true;
                weekSection.style.display = 'block';
                document.getElementById('birthdaysWeek').innerHTML = week.map(b => `
                    <div style="padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${b.client.name}</strong>
                                <span style="color: #666; margin-left: 10px;">
                                    ${b.date.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })}
                                    (${b.age} anni)
                                </span>
                            </div>
                            <span style="background: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 20px; font-size: 14px;">
                                tra ${b.daysUntil} ${b.daysUntil === 1 ? 'giorno' : 'giorni'}
                            </span>
                        </div>
                    </div>
                `).join('');
            }
            
            // Compleanni del mese
            if (month.length > 0) {
                hasBirthdays = true;
                monthSection.style.display = 'block';
                document.getElementById('birthdaysMonth').innerHTML = month.map(b => `
                    <div style="padding: 10px; background: white; border-radius: 6px; margin-bottom: 6px;">
                        <strong>${b.client.name}</strong>
                        <span style="color: #666; margin-left: 10px;">
                            ${b.date.toLocaleDateString('it-IT', { day: 'numeric', month: 'long' })}
                            (tra ${b.daysUntil} giorni)
                        </span>
                    </div>
                `).join('');
            }
            
            if (!hasBirthdays) {
                noBirthdaysMsg.style.display = 'block';
            }
        }

        function sendBirthdayWhatsApp(phone, name) {
            const message = encodeURIComponent(`Auguri di buon compleanno ${name}! 🎂🎉 Ti auguro una giornata speciale!`);
            openWhatsApp(phone + '&text=' + message);
        }

        function sendBirthdayEmail(email, name) {
            const subject = encodeURIComponent(`Auguri di Buon Compleanno ${name}! 🎂`);
            const body = encodeURIComponent(`Gentile ${name},\n\nTanti auguri di buon compleanno!\n\nTi auguro una giornata meravigliosa e un anno ricco di soddisfazioni.\n\nCordiali saluti`);
            window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
        }

        function toggleBirthdayNotifications() {
            const enabled = document.getElementById('birthdayNotifications').checked;
            localStorage.setItem('birthdayNotificationsEnabled', enabled ? 'true' : 'false');
        }

        function checkBirthdaysOnStartup() {
            const enabled = localStorage.getItem('birthdayNotificationsEnabled') === 'true';
            document.getElementById('birthdayNotifications').checked = enabled;
            
            if (enabled) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let birthdaysToday = 0;
                let birthdaysWeek = 0;
                
                clients.forEach(client => {
                    if (!client.birthDate) return;
                    
                    const birthDate = new Date(client.birthDate);
                    const birthDay = birthDate.getDate();
                    const birthMonth = birthDate.getMonth();
                    
                    // Controlla se è oggi
                    if (birthDay === today.getDate() && birthMonth === today.getMonth()) {
                        birthdaysToday++;
                    } else {
                        // Calcola il prossimo compleanno
                        let nextBirthday = new Date(today.getFullYear(), birthMonth, birthDay);
                        if (nextBirthday < today) {
                            nextBirthday = new Date(today.getFullYear() + 1, birthMonth, birthDay);
                        }
                        
                        const daysUntil = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
                        if (daysUntil >= 1 && daysUntil <= 7) {
                            birthdaysWeek++;
                        }
                    }
                });
                
                if (birthdaysToday > 0 || birthdaysWeek > 0) {
                    setTimeout(() => {
                        let message = '🎂 Promemoria Compleanni:\n\n';
                        if (birthdaysToday > 0) {
                            message += `🎉 ${birthdaysToday} ${birthdaysToday === 1 ? 'compleanno' : 'compleanni'} OGGI!\n`;
                        }
                        if (birthdaysWeek > 0) {
                            message += `📅 ${birthdaysWeek} ${birthdaysWeek === 1 ? 'compleanno' : 'compleanni'} nei prossimi 7 giorni\n`;
                        }
                        message += '\nVuoi vedere i dettagli?';
                        
                        if (confirm(message)) {
                            openBirthdayModal();
                        }
                    }, 1000);
                }
            }
        }

        // WhatsApp integration fix
        function openWhatsApp(phoneOrParams) {
            if (phoneOrParams.includes('&text=')) {
                // È già formattato con testo
                window.open(`https://wa.me/${phoneOrParams}`, '_blank');
            } else {
                // È solo il numero
                let cleanPhone = phoneOrParams.replace(/[^0-9+]/g, '');
                if (!cleanPhone.startsWith('+')) {
                    cleanPhone = '+39' + cleanPhone;
                }
                window.open(`https://wa.me/${cleanPhone}`, '_blank');
            }
        }

        function updateBirthdayBadge() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let todayCount = 0;
            
            clients.forEach(client => {
                if (client.birthDate) {
                    const birthDate = new Date(client.birthDate);
                    const birthDay = birthDate.getDate();
                    const birthMonth = birthDate.getMonth();
                    
                    // Controlla se il compleanno è oggi
                    if (birthDay === today.getDate() && birthMonth === today.getMonth()) {
                        todayCount++;
                    }
                }
            });
            
            const badge = document.getElementById('birthdayBadge');
            if (todayCount > 0) {
                badge.style.display = 'flex';
                badge.textContent = todayCount;
            } else {
                badge.style.display = 'none';
            }
        }

        // Email integration
        function sendEmail(email, clientName) {
            if (email) {
                // Create email with pre-filled subject
                const subject = encodeURIComponent(`Comunicazione per ${clientName}`);
                const body = encodeURIComponent(`Gentile ${clientName},\n\n`);
                
                // Open default email client
                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
            }
        }

        // Render
        function renderLists() {
            renderClientsList(clients.filter(c => c.type === 'cliente'), 'clients-list');
            renderClientsList(clients.filter(c => c.type === 'prospect'), 'prospects-list');
            renderClientsList(clients, 'all-list');
        }

        function renderClientsList(list, containerId) {
            const container = document.getElementById(containerId);
            if (list.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Nessun contatto</p></div>';
                return;
            }
            
            container.innerHTML = list.map(client => {
                const totalValue = client.products ? client.products.reduce((sum, p) => sum + p.value, 0) : 0;
                return `
                    <div class="client-card" onclick="showClientDetail('${client.id}')">
                        <h3>${client.name} <span class="client-type ${client.type === 'prospect' ? 'prospect' : ''}">${client.type}</span></h3>
                        ${(client.generation || client.birthDate) ? `
                            <span style="background: ${getGenerationColor(client.generation || calculateGeneration(client.birthDate))}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                ${getGenerationLabel(client.generation || calculateGeneration(client.birthDate))}
                            </span>
                        ` : ''}
                        ${client.cf ? `<p style="font-size: 12px; color: #666; margin-top: 5px;">CF: ${client.cf}</p>` : ''}
                        ${(client.city || client.province) ? `<p style="font-size: 14px; color: #666;">📍 ${[client.city, client.province].filter(Boolean).join(' - ')}</p>` : ''}
                        ${client.phone ? `<p>📱 ${client.phone} ${client.phoneFlow === 'certificato' ? '✓' : ''}</p>` : ''}
                        ${client.email ? `<p>📧 ${client.email}</p>` : ''}
                        ${client.onlineServices ? `<p>🌐 Servizi Online: ${client.onlineServices}</p>` : ''}
                        ${client.products && client.products.length > 0 ? `<p>💼 ${client.products.length} prodotti (€ ${totalValue.toLocaleString('it-IT', {minimumFractionDigits: 2})})</p>` : ''}
                        ${client.meetings && client.meetings.length > 0 ? `<p>📅 ${client.meetings.length} incontri</p>` : ''}
                        ${client.documents && client.documents.length > 0 ? `<p>📄 ${client.documents.length} documenti</p>` : ''}
                        <div style="margin-top: 10px;" onclick="event.stopPropagation()">
                            <button class="btn btn-primary btn-small" onclick="openEditModal('${client.id}')">Modifica</button>
                            <button class="btn btn-danger btn-small" onclick="deleteClient('${client.id}')">Elimina</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Stats
        function updateStats() {
            document.getElementById('totalClients').textContent = clients.length;
            document.getElementById('activeClients').textContent = clients.filter(c => c.type === 'cliente').length;
            document.getElementById('totalProspects').textContent = clients.filter(c => c.type === 'prospect').length;
        }

        // Notification
        function showNotification(message) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.classList.add('show'), 100);
            setTimeout(() => {
                notif.classList.remove('show');
                setTimeout(() => document.body.removeChild(notif), 300);
            }, 3000);
        }

        // Storage
        function saveData() {
            try {
                const dataString = JSON.stringify(clients);
                
                // Controlla la dimensione dei dati
                const dataSize = new Blob([dataString]).size;
                const sizeMB = (dataSize / (1024 * 1024)).toFixed(2);
                
                // localStorage ha un limite di circa 5-10MB dipendendo dal browser
                if (dataSize > 4 * 1024 * 1024) { // 4MB di soglia di sicurezza
                    console.warn(`Attenzione: i dati occupano ${sizeMB}MB. Considera di ridurre le immagini.`);
                }
                
                localStorage.setItem('crmClients', dataString);
                
                // Aggiorna indicatore spazio se siamo nel modal backup
                if (document.getElementById('backupModal').style.display === 'block') {
                    updateStorageIndicator();
                }
                
            } catch (error) {
                console.error('Errore nel salvataggio dati:', error);
                
                if (error.name === 'QuotaExceededError') {
                    // Prova a liberare spazio
                    try {
                        // Rimuovi dati temporanei se presenti
                        const keysToCheck = ['lastReminderDate', 'importData'];
                        keysToCheck.forEach(key => {
                            if (localStorage.getItem(key)) {
                                localStorage.removeItem(key);
                            }
                        });
                        
                        // Riprova il salvataggio
                        localStorage.setItem('crmClients', JSON.stringify(clients));
                        
                    } catch (retryError) {
                        alert('Spazio di archiviazione esaurito! Le immagini dei documenti sono troppo grandi. Riduci le dimensioni delle immagini o elimina alcuni documenti.');
                        throw retryError;
                    }
                } else {
                    throw error;
                }
            }
        }

        function loadData() {
            const saved = localStorage.getItem('crmClients');
            if (saved) {
                clients = JSON.parse(saved);
            }
        }

        // Import/Export Functions
        function openImportModal() {
            document.getElementById('importForm').reset();
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importBtn').disabled = true;
            document.getElementById('importModal').style.display = 'block';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }

        function downloadTemplate() {
            const template = '"Nominativo Cliente","Data di Nascita","Codice Fiscale","Residenza","Telefono","Flusso Telefonico","Email","Servizi Online","My Key","Profilo MIFID","Tipo","Note"\n' +
                           '"Mario Rossi","15/03/1970","RSSMRA70C15H501X","Via Roma, 1 Milano","333-1234567","certificato","mario.rossi@email.com","SI","MYKEY_SMART","Moderato","cliente","Cliente importante"\n' +
                           '"Luigi Bianchi","22/07/1985","BNCLGU85L22F205Y","Via Milano, 2 Roma","335-9876543","non_certificato","luigi.bianchi@email.com","NO","NESSUN_MYKEY","Dinamico","prospect","Potenziale cliente"\n';
            
            const blob = new Blob(['\ufeff' + template], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'template_importazione_clienti.csv';
            link.click();
        }

        let importData = [];

        // Helper function to convert date format
        function convertDateFormat(dateStr) {
            if (!dateStr) return '';
            // Convert from DD/MM/YYYY to YYYY-MM-DD
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            return dateStr;
        }

        function previewImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Mostra indicatore di caricamento
            const preview = document.getElementById('previewContent');
            preview.innerHTML = '<div style="text-align: center; padding: 20px;"><strong>Caricamento in corso...</strong><br><small>Attendere prego...</small></div>';
            document.getElementById('importPreview').style.display = 'block';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    let data = [];

                    if (file.name.endsWith('.csv')) {
                        // Parse CSV con gestione migliore delle virgole
                        const lines = text.split(/\r?\n/).filter(line => line.trim());
                        
                        // Funzione per split CSV che gestisce le virgole dentro le virgolette
                        function parseCSVLine(line) {
                            const result = [];
                            let current = '';
                            let inQuotes = false;
                            
                            for (let i = 0; i < line.length; i++) {
                                const char = line[i];
                                
                                if (char === '"') {
                                    inQuotes = !inQuotes;
                                } else if (char === ',' && !inQuotes) {
                                    result.push(current.trim());
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }
                            result.push(current.trim());
                            
                            return result;
                        }
                        
                        // Salta l'header
                        for (let i = 1; i < lines.length; i++) {
                            const values = parseCSVLine(lines[i]);
                            if (values[0]) { // Check if name exists
                                data.push({
                                    name: values[0] || '',
                                    birthDate: convertDateFormat(values[1]) || '',
                                    cf: (values[2] || '').toUpperCase(),
                                    address: values[3] || '',
                                    phone: values[4] || '',
                                    phoneFlow: values[5] || '',
                                    email: values[6] || '',
                                    onlineServices: values[7] || '',
                                    myKey: values[8] || 'NESSUN_MYKEY',
                                    mifid: values[9] || '',
                                    type: values[10] || 'cliente',
                                    notes: values[11] || ''
                                });
                            }
                        }
                    } else {
                        throw new Error('Formato file non supportato. Usa file CSV.');
                    }

                    importData = data;
                    displayPreview(data);
                } catch (error) {
                    preview.innerHTML = `<div style="color: red; padding: 20px;">
                        <strong>Errore durante il caricamento:</strong><br>
                        ${error.message}<br><br>
                        <small>Verifica che il file sia in formato CSV e che rispetti il template.</small>
                    </div>`;
                    document.getElementById('importBtn').disabled = true;
                }
            };

            reader.onerror = function() {
                preview.innerHTML = '<div style="color: red; padding: 20px;">Errore nella lettura del file. Riprova.</div>';
                document.getElementById('importBtn').disabled = true;
            };

            reader.readAsText(file, 'UTF-8');
        }

        function displayPreview(data) {
            const preview = document.getElementById('previewContent');
            const summary = document.getElementById('importSummary');
            
            if (data.length === 0) {
                preview.innerHTML = '<p style="color: red;">Nessun dato valido trovato nel file</p>';
                document.getElementById('importBtn').disabled = true;
                return;
            }

            // Show first 5 records as preview
            const previewHtml = data.slice(0, 5).map((row, index) => `
                <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px;">
                    <strong>${index + 1}. ${row.name}</strong> (${row.type})<br>
                    ${row.cf ? `CF: ${row.cf}<br>` : ''}
                    ${row.phone ? `Tel: ${row.phone} (${row.phoneFlow || 'non specificato'})<br>` : ''}
                    ${row.email ? `Email: ${row.email}<br>` : ''}
                    ${row.onlineServices ? `Servizi Online: ${row.onlineServices}<br>` : ''}
                    ${row.myKey ? `MyKey: ${row.myKey}<br>` : ''}
                    ${row.mifid ? `MIFID: ${row.mifid}` : ''}
                </div>
            `).join('');

            preview.innerHTML = previewHtml + (data.length > 5 ? `<p>... e altri ${data.length - 5} record</p>` : '');
            summary.textContent = `Totale record da importare: ${data.length}`;
            
            document.getElementById('importPreview').style.display = 'block';
            document.getElementById('importBtn').disabled = false;
        }

        function importClients(event) {
            event.preventDefault();
            
            if (importData.length === 0) {
                alert('Nessun dato da importare');
                return;
            }

            // Disabilita il pulsante e mostra stato
            const importBtn = document.getElementById('importBtn');
            const originalText = importBtn.innerHTML;
            importBtn.disabled = true;
            importBtn.innerHTML = '⏳ Importazione in corso...';

            // Usa setTimeout per permettere all'UI di aggiornarsi
            setTimeout(() => {
                try {
                    let imported = 0;
                    let skipped = 0;
                    let errors = [];

                    importData.forEach((row, index) => {
                        try {
                            // Validazione base
                            if (!row.name || row.name.trim() === '') {
                                errors.push(`Riga ${index + 2}: Nome mancante`);
                                return;
                            }

                            // Check if client already exists by name and CF
                            const exists = clients.some(c => 
                                c.name.toLowerCase() === row.name.toLowerCase() || 
                                (row.cf && c.cf && c.cf.toLowerCase() === row.cf.toLowerCase())
                            );
                            
                            if (!exists) {
                                // Validazione e normalizzazione dati
                                const newClient = {
                                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                                    name: row.name.trim(),
                                    birthDate: row.birthDate || '',
                                    cf: row.cf ? row.cf.toUpperCase().trim() : '',
                                    address: row.address || '',
                                    civic: '',
                                    city: '',
                                    zip: '',
                                    province: '',
                                    phone: row.phone || '',
                                    phoneFlow: ['certificato', 'non_certificato'].includes(row.phoneFlow) ? row.phoneFlow : '',
                                    email: row.email || '',
                                    onlineServices: ['SI', 'NO'].includes(row.onlineServices) ? row.onlineServices : '',
                                    myKey: ['MYKEY_SMART', 'MYKEY_SMS', 'NESSUN_MYKEY'].includes(row.myKey) ? row.myKey : 'NESSUN_MYKEY',
                                    mifid: ['Conservativo', 'Moderato', 'Dinamico', 'Attivo'].includes(row.mifid) ? row.mifid : '',
                                    type: ['cliente', 'prospect'].includes(row.type) ? row.type : 'cliente',
                                    notes: row.notes || '',
                                    createdAt: new Date().toISOString(),
                                    products: [],
                                    meetings: [],
                                    documents: [],
                                    familyMembers: []
                                };
                                
                                clients.push(newClient);
                                imported++;
                            } else {
                                skipped++;
                            }
                        } catch (rowError) {
                            errors.push(`Riga ${index + 2}: ${rowError.message}`);
                        }
                    });

                    // Salva e aggiorna
                    saveData();
                    renderLists();
                    updateStats();
                    
                    // Ripristina il pulsante
                    importBtn.disabled = false;
                    importBtn.innerHTML = originalText;
                    
                    // Chiudi modal e mostra risultato
                    closeImportModal();
                    
                    // Messaggio di riepilogo
                    let message = `✅ Importazione completata!\n\n`;
                    message += `• ${imported} clienti importati con successo\n`;
                    if (skipped > 0) {
                        message += `• ${skipped} clienti saltati (già esistenti)\n`;
                    }
                    if (errors.length > 0) {
                        message += `\n⚠️ Errori riscontrati:\n${errors.slice(0, 5).join('\n')}`;
                        if (errors.length > 5) {
                            message += `\n... e altri ${errors.length - 5} errori`;
                        }
                    }
                    
                    alert(message);
                    
                } catch (error) {
                    // Ripristina il pulsante in caso di errore
                    importBtn.disabled = false;
                    importBtn.innerHTML = originalText;
                    
                    alert('Errore durante l\'importazione: ' + error.message);
                }
            }, 100);
        }

        // Export to Excel
        function exportToExcel() {
            let csv = '\ufeff'; // UTF-8 BOM for Excel
            csv += 'Nominativo Cliente,Data di Nascita,Generazione,Codice Fiscale,Indirizzo,Numero Civico,Comune,CAP,Provincia,Telefono,Flusso Telefonico,Email,Servizi Online,My Key,Profilo MIFID,Tipo,Note,Numero Prodotti,Valore Portfolio,Numero Incontri,Numero Documenti\n';
            
            clients.forEach(client => {
                const totalValue = client.products ? client.products.reduce((sum, p) => {
                    const value = p.currentValue !== undefined ? p.currentValue : (p.value || 0);
                    return sum + value;
                }, 0) : 0;
                const birthDateFormatted = client.birthDate ? 
                    new Date(client.birthDate).toLocaleDateString('it-IT') : '';
                const generation = getGenerationLabel(client.generation || calculateGeneration(client.birthDate));
                
                const row = [
                    client.name,
                    birthDateFormatted,
                    generation,
                    client.cf || '',
                    client.address || '',
                    client.civic || '',
                    client.city || '',
                    client.zip || '',
                    client.province || '',
                    client.phone || '',
                    client.phoneFlow || '',
                    client.email || '',
                    client.onlineServices || '',
                    client.myKey || '',
                    client.mifid || '',
                    client.type,
                    client.notes ? client.notes.replace(/,/g, ';') : '',
                    client.products ? client.products.length : 0,
                    totalValue,
                    client.meetings ? client.meetings.length : 0,
                    client.documents ? client.documents.length : 0
                ].join(',');
                csv += row + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'esportazione_crm_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            
            showNotification('Esportazione completata!');
        }

        // Backup Functions
        function openBackupModal() {
            updateBackupStatus();
            updateBackupStats();
            loadBackupSettings();
            document.getElementById('backupModal').style.display = 'block';
        }

        function closeBackupModal() {
            document.getElementById('backupModal').style.display = 'none';
        }

        function updateBackupStatus() {
            const lastBackup = localStorage.getItem('lastBackupDate');
            const statusDiv = document.getElementById('backupStatus');
            
            if (!lastBackup) {
                statusDiv.className = 'backup-status danger';
                statusDiv.innerHTML = '⚠️ <strong>Attenzione!</strong> Non hai mai effettuato un backup';
            } else {
                const lastBackupDate = new Date(lastBackup);
                const daysSinceBackup = Math.floor((new Date() - lastBackupDate) / (1000 * 60 * 60 * 24));
                
                if (daysSinceBackup === 0) {
                    statusDiv.className = 'backup-status ok';
                    statusDiv.innerHTML = '✅ <strong>Backup aggiornato</strong> - Effettuato oggi';
                } else if (daysSinceBackup <= 7) {
                    statusDiv.className = 'backup-status ok';
                    statusDiv.innerHTML = `✅ <strong>Backup recente</strong> - ${daysSinceBackup} giorni fa`;
                } else if (daysSinceBackup <= 14) {
                    statusDiv.className = 'backup-status warning';
                    statusDiv.innerHTML = `⚠️ <strong>Backup da aggiornare</strong> - ${daysSinceBackup} giorni fa`;
                } else {
                    statusDiv.className = 'backup-status danger';
                    statusDiv.innerHTML = `❌ <strong>Backup obsoleto!</strong> - ${daysSinceBackup} giorni fa`;
                }
            }
            
            document.getElementById('lastBackupDate').textContent = lastBackup ? 
                new Date(lastBackup).toLocaleDateString('it-IT', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Mai effettuato';
        }

        function updateBackupStats() {
            let totalProducts = 0;
            let totalDocs = 0;
            let totalMeetings = 0;
            
            clients.forEach(client => {
                totalProducts += (client.products || []).length;
                totalDocs += (client.documents || []).length;
                totalMeetings += (client.meetings || []).length;
            });
            
            document.getElementById('backupTotalClients').textContent = clients.length;
            document.getElementById('backupTotalProducts').textContent = totalProducts;
            document.getElementById('backupTotalDocs').textContent = totalDocs;
            document.getElementById('backupTotalMeetings').textContent = totalMeetings;
            
            // Aggiorna anche lo spazio utilizzato
            updateStorageIndicator();
        }
        
        function updateStorageIndicator() {
            try {
                // Calcola la dimensione dei dati
                const dataString = JSON.stringify(clients);
                const dataSize = new Blob([dataString]).size;
                const dataSizeMB = dataSize / (1024 * 1024);
                const maxSizeMB = 10; // Limite stimato localStorage
                const percentage = (dataSizeMB / maxSizeMB) * 100;
                
                // Aggiorna UI
                document.getElementById('storageBar').style.width = Math.min(percentage, 100) + '%';
                document.getElementById('storageUsed').textContent = dataSizeMB.toFixed(2) + ' MB';
                document.getElementById('storagePercent').textContent = Math.round(percentage) + '%';
                
                // Gestisci avvisi
                const warningEl = document.getElementById('storageWarning');
                const criticalEl = document.getElementById('storageCritical');
                
                if (percentage >= 90) {
                    // Critico
                    document.getElementById('storageBar').style.background = '#ef4444';
                    warningEl.style.display = 'none';
                    criticalEl.style.display = 'block';
                } else if (percentage >= 70) {
                    // Warning
                    document.getElementById('storageBar').style.background = '#f59e0b';
                    warningEl.style.display = 'block';
                    criticalEl.style.display = 'none';
                } else {
                    // Normale
                    document.getElementById('storageBar').style.background = 'var(--primary)';
                    warningEl.style.display = 'none';
                    criticalEl.style.display = 'none';
                }
                
                // Calcola dettagli per tipo di dato
                let imageSize = 0;
                let documentSize = 0;
                
                clients.forEach(client => {
                    // Dimensione immagini compliance
                    if (client.compliance && client.compliance.document) {
                        if (client.compliance.document.imageFront) {
                            imageSize += new Blob([client.compliance.document.imageFront]).size;
                        }
                        if (client.compliance.document.imageBack) {
                            imageSize += new Blob([client.compliance.document.imageBack]).size;
                        }
                    }
                    
                    // Dimensione documenti
                    if (client.documents) {
                        client.documents.forEach(doc => {
                            if (doc.data) {
                                documentSize += new Blob([doc.data]).size;
                            }
                        });
                    }
                });
                
                // Mostra dettagli se richiesto (per debug)
                console.log('Storage Details:', {
                    total: dataSizeMB.toFixed(2) + ' MB',
                    images: (imageSize / (1024 * 1024)).toFixed(2) + ' MB',
                    documents: (documentSize / (1024 * 1024)).toFixed(2) + ' MB',
                    other: ((dataSize - imageSize - documentSize) / (1024 * 1024)).toFixed(2) + ' MB'
                });
                
            } catch (error) {
                console.error('Errore calcolo storage:', error);
            }
        }

        function toggleAutoBackup() {
            const enabled = document.getElementById('autoBackup').checked;
            document.getElementById('backupDaySelect').style.display = enabled ? 'block' : 'none';
            
            if (enabled) {
                localStorage.setItem('autoBackupEnabled', 'true');
                const backupDay = document.getElementById('backupDay').value;
                localStorage.setItem('backupDay', backupDay);
                updateNextBackupInfo();
            } else {
                localStorage.removeItem('autoBackupEnabled');
                localStorage.removeItem('backupDay');
                document.getElementById('nextBackupInfo').textContent = '';
            }
        }

        function updateBackupDay() {
            const backupDay = document.getElementById('backupDay').value;
            localStorage.setItem('backupDay', backupDay);
            updateNextBackupInfo();
        }

        function updateNextBackupInfo() {
            const backupDay = parseInt(document.getElementById('backupDay').value);
            const today = new Date();
            const currentDay = today.getDay();
            let daysUntilBackup = backupDay - currentDay;
            
            if (daysUntilBackup <= 0) {
                daysUntilBackup += 7;
            }
            
            const nextBackup = new Date();
            nextBackup.setDate(today.getDate() + daysUntilBackup);
            
            document.getElementById('nextBackupInfo').textContent = 
                `Prossimo promemoria: ${nextBackup.toLocaleDateString('it-IT', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long' 
                })}`;
        }

        function loadBackupSettings() {
            const autoBackupEnabled = localStorage.getItem('autoBackupEnabled') === 'true';
            const backupDay = localStorage.getItem('backupDay') || '5'; // Default Friday
            
            document.getElementById('autoBackup').checked = autoBackupEnabled;
            document.getElementById('backupDay').value = backupDay;
            document.getElementById('backupDaySelect').style.display = autoBackupEnabled ? 'block' : 'none';
            
            if (autoBackupEnabled) {
                updateNextBackupInfo();
            }
        }

        function checkBackupReminder() {
            const autoBackupEnabled = localStorage.getItem('autoBackupEnabled') === 'true';
            if (!autoBackupEnabled) return;
            
            const lastBackup = localStorage.getItem('lastBackupDate');
            const backupDay = parseInt(localStorage.getItem('backupDay') || '5');
            const today = new Date();
            
            // Check if today is the backup day
            if (today.getDay() === backupDay) {
                const lastReminderDate = localStorage.getItem('lastReminderDate');
                const todayStr = today.toDateString();
                
                // Show reminder only once per day
                if (lastReminderDate !== todayStr) {
                    localStorage.setItem('lastReminderDate', todayStr);
                    
                    if (!lastBackup || (new Date() - new Date(lastBackup)) > 7 * 24 * 60 * 60 * 1000) {
                        setTimeout(() => {
                            if (confirm('🔔 Promemoria Backup Settimanale!\n\nÈ il giorno programmato per il backup. Vuoi effettuarlo ora?')) {
                                openBackupModal();
                            }
                        }, 2000);
                    }
                }
            }
        }

        function backupFull() {
            const backupData = {
                version: '2.0',
                date: new Date().toISOString(),
                clients: clients,
                settings: {
                    autoBackupEnabled: localStorage.getItem('autoBackupEnabled'),
                    backupDay: localStorage.getItem('backupDay')
                }
            };
            
            const json = JSON.stringify(backupData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup_crm_completo_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            localStorage.setItem('lastBackupDate', new Date().toISOString());
            updateBackupStatus();
            showNotification('✅ Backup completo salvato con successo!');
        }

        function backupExcel() {
            exportToExcel();
            localStorage.setItem('lastBackupDate', new Date().toISOString());
            updateBackupStatus();
        }

        function restoreBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.clients && Array.isArray(data.clients)) {
                            if (confirm('⚠️ ATTENZIONE!\n\nQuesto sostituirà TUTTI i dati attuali con quelli del backup.\n\nSei sicuro di voler procedere?')) {
                                clients = data.clients;
                                saveData();
                                renderLists();
                                updateStats();
                                showNotification('✅ Backup ripristinato con successo!');
                                closeBackupModal();
                            }
                        } else {
                            alert('File di backup non valido');
                        }
                    } catch (error) {
                        alert('Errore nel caricamento del backup: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Quick Import Functions
        let quickImportData = [];
        let columnMapping = {};
        let detectedSeparator = ',';

        function openQuickImportModal() {
            resetQuickImport();
            document.getElementById('quickImportModal').style.display = 'block';
        }

        function closeQuickImportModal() {
            document.getElementById('quickImportModal').style.display = 'none';
        }

        function resetQuickImport() {
            quickImportData = [];
            columnMapping = {};
            document.getElementById('quickImportStep1').style.display = 'block';
            document.getElementById('quickImportStep2').style.display = 'none';
            document.getElementById('quickImportStep3').style.display = 'none';
            document.getElementById('pasteArea').style.display = 'none';
            document.getElementById('pasteTextarea').value = '';
            document.getElementById('quickImportFile').value = '';
        }

        function showPasteArea() {
            document.getElementById('pasteArea').style.display = 'block';
            document.getElementById('pasteTextarea').focus();
        }

        function detectSeparator(text) {
            const lines = text.trim().split('\n').slice(0, 5); // Analizza prime 5 righe
            const separators = [',', ';', '\t', '|', '-'];
            let bestSeparator = ',';
            let maxConsistency = 0;

            separators.forEach(sep => {
                const counts = lines.map(line => (line.match(new RegExp('\\' + sep, 'g')) || []).length);
                const avgCount = counts.reduce((a, b) => a + b, 0) / counts.length;
                const consistency = avgCount > 0 && counts.every(c => c === counts[0]) ? avgCount : 0;
                
                if (consistency > maxConsistency) {
                    maxConsistency = consistency;
                    bestSeparator = sep;
                }
            });

            return bestSeparator;
        }

        function processPastedData() {
            const text = document.getElementById('pasteTextarea').value.trim();
            if (!text) {
                alert('Per favore incolla alcuni dati da importare');
                return;
            }

            try {
                detectedSeparator = detectSeparator(text);
                const lines = text.split('\n').filter(line => line.trim());
                
                // Analizza la struttura
                const firstLine = lines[0];
                const isHeader = isNaN(firstLine.charAt(0)) && !firstLine.includes('@');
                
                let headers = [];
                let dataLines = lines;
                
                if (isHeader) {
                    headers = firstLine.split(detectedSeparator).map(h => h.trim());
                    dataLines = lines.slice(1);
                } else {
                    // Genera headers automatici
                    const numColumns = firstLine.split(detectedSeparator).length;
                    headers = Array.from({length: numColumns}, (_, i) => `Colonna ${i + 1}`);
                }

                // Parse data
                quickImportData = dataLines.map(line => {
                    const values = line.split(detectedSeparator).map(v => v.trim());
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    return row;
                });

                // Auto-detect column types
                autoDetectColumns(headers, quickImportData);
                showMappingStep();
                
            } catch (error) {
                alert('Errore nell\'analisi dei dati. Verifica il formato e riprova.');
            }
        }

        function handleQuickImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                if (file.name.endsWith('.csv') || file.name.endsWith('.txt')) {
                    document.getElementById('pasteTextarea').value = e.target.result;
                    processPastedData();
                } else {
                    alert('Per file Excel, usa l\'importazione standard. L\'import rapido supporta CSV e file di testo.');
                }
            };
            reader.readAsText(file);
        }

        function autoDetectColumns(headers, data) {
            columnMapping = {};
            
            headers.forEach((header, index) => {
                const headerLower = header.toLowerCase();
                const sampleValues = data.slice(0, 5).map(row => row[header]).filter(v => v);
                
                // Riconoscimento Nome
                if (headerLower.includes('nome') || headerLower.includes('nominativo') || 
                    headerLower.includes('cliente') || headerLower.includes('name')) {
                    columnMapping[header] = 'name';
                }
                // Riconoscimento Telefono
                else if (headerLower.includes('tel') || headerLower.includes('phone') || 
                         headerLower.includes('cell') || 
                         sampleValues.some(v => /^[\d\s\-\+\(\)]+$/.test(v) && v.length > 6)) {
                    columnMapping[header] = 'phone';
                }
                // Riconoscimento Email
                else if (headerLower.includes('mail') || headerLower.includes('email') ||
                         sampleValues.some(v => v.includes('@'))) {
                    columnMapping[header] = 'email';
                }
                // Riconoscimento Codice Fiscale
                else if (headerLower.includes('codice') || headerLower.includes('fiscale') || 
                         headerLower.includes('cf') ||
                         sampleValues.some(v => /^[A-Z]{6}\d{2}[A-Z]\d{2}[A-Z]\d{3}[A-Z]$/i.test(v))) {
                    columnMapping[header] = 'cf';
                }
                // Riconoscimento Indirizzo
                else if (headerLower.includes('via') || headerLower.includes('indirizzo') || 
                         headerLower.includes('address') || headerLower.includes('residenza')) {
                    columnMapping[header] = 'address';
                }
                // Riconoscimento Città
                else if (headerLower.includes('città') || headerLower.includes('citta') || 
                         headerLower.includes('comune') || headerLower.includes('city')) {
                    columnMapping[header] = 'city';
                }
                // Riconoscimento CAP
                else if (headerLower.includes('cap') || headerLower.includes('zip') ||
                         sampleValues.some(v => /^\d{5}$/.test(v))) {
                    columnMapping[header] = 'zip';
                }
                // Riconoscimento Provincia
                else if (headerLower.includes('prov') || 
                         sampleValues.some(v => /^[A-Z]{2}$/i.test(v))) {
                    columnMapping[header] = 'province';
                }
                // Riconoscimento Note
                else if (headerLower.includes('note') || headerLower.includes('notes')) {
                    columnMapping[header] = 'notes';
                }
                // Riconoscimento Tipo
                else if (headerLower.includes('tipo') || headerLower.includes('type')) {
                    columnMapping[header] = 'type';
                }
            });
        }

        function showMappingStep() {
            document.getElementById('quickImportStep1').style.display = 'none';
            document.getElementById('quickImportStep2').style.display = 'block';
            
            const mappingArea = document.getElementById('columnMappingArea');
            const headers = Object.keys(quickImportData[0]);
            
            mappingArea.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f3f4f6;">
                            <th style="padding: 10px; text-align: left;">Colonna nel file</th>
                            <th style="padding: 10px; text-align: left;">Esempio valori</th>
                            <th style="padding: 10px; text-align: left;">Importa come</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${headers.map(header => {
                            const samples = quickImportData.slice(0, 3).map(row => row[header]).filter(v => v).join(', ');
                            return `
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 10px;"><strong>${header}</strong></td>
                                    <td style="padding: 10px; color: #666; font-size: 14px;">${samples || 'Vuoto'}</td>
                                    <td style="padding: 10px;">
                                        <select class="column-mapping" data-header="${header}" style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;">
                                            <option value="">-- Non importare --</option>
                                            <option value="name" ${columnMapping[header] === 'name' ? 'selected' : ''}>Nome Cliente</option>
                                            <option value="phone" ${columnMapping[header] === 'phone' ? 'selected' : ''}>Telefono</option>
                                            <option value="email" ${columnMapping[header] === 'email' ? 'selected' : ''}>Email</option>
                                            <option value="cf" ${columnMapping[header] === 'cf' ? 'selected' : ''}>Codice Fiscale</option>
                                            <option value="address" ${columnMapping[header] === 'address' ? 'selected' : ''}>Indirizzo</option>
                                            <option value="city" ${columnMapping[header] === 'city' ? 'selected' : ''}>Comune</option>
                                            <option value="zip" ${columnMapping[header] === 'zip' ? 'selected' : ''}>CAP</option>
                                            <option value="province" ${columnMapping[header] === 'province' ? 'selected' : ''}>Provincia</option>
                                            <option value="notes" ${columnMapping[header] === 'notes' ? 'selected' : ''}>Note</option>
                                            <option value="type" ${columnMapping[header] === 'type' ? 'selected' : ''}>Tipo (cliente/prospect)</option>
                                        </select>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            // Aggiungi event listeners
            document.querySelectorAll('.column-mapping').forEach(select => {
                select.addEventListener('change', function() {
                    const header = this.dataset.header;
                    const value = this.value;
                    if (value) {
                        // Rimuovi mapping duplicati
                        Object.keys(columnMapping).forEach(key => {
                            if (columnMapping[key] === value && key !== header) {
                                delete columnMapping[key];
                                document.querySelector(`select[data-header="${key}"]`).value = '';
                            }
                        });
                        columnMapping[header] = value;
                    } else {
                        delete columnMapping[header];
                    }
                });
            });
        }

        function backToStep1() {
            document.getElementById('quickImportStep1').style.display = 'block';
            document.getElementById('quickImportStep2').style.display = 'none';
        }

        function backToStep2() {
            document.getElementById('quickImportStep2').style.display = 'block';
            document.getElementById('quickImportStep3').style.display = 'none';
        }

        function goToStep3() {
            // Verifica che almeno il nome sia mappato
            const hasName = Object.values(columnMapping).includes('name');
            if (!hasName) {
                alert('Per favore seleziona quale colonna contiene il Nome del cliente');
                return;
            }
            
            // Prepara preview
            prepareImportPreview();
            
            document.getElementById('quickImportStep2').style.display = 'none';
            document.getElementById('quickImportStep3').style.display = 'block';
        }

        function prepareImportPreview() {
            const previewArea = document.getElementById('quickImportPreview');
            const summaryArea = document.getElementById('quickImportSummary');
            
            // Prepara i dati per l'import
            const importReady = quickImportData.map((row, index) => {
                const client = {
                    type: 'cliente' // Default
                };
                
                Object.keys(columnMapping).forEach(header => {
                    const field = columnMapping[header];
                    const value = row[header] || '';
                    
                    switch(field) {
                        case 'name': client.name = value; break;
                        case 'phone': client.phone = value; break;
                        case 'email': client.email = value; break;
                        case 'cf': client.cf = value.toUpperCase(); break;
                        case 'address': client.address = value; break;
                        case 'city': client.city = value; break;
                        case 'zip': client.zip = value; break;
                        case 'province': client.province = value.toUpperCase(); break;
                        case 'notes': client.notes = value; break;
                        case 'type': 
                            client.type = value.toLowerCase().includes('prospect') ? 'prospect' : 'cliente';
                            break;
                    }
                });
                
                return client;
            }).filter(c => c.name); // Solo record con nome
            
            // Mostra preview
            previewArea.innerHTML = `
                <h4 style="margin-bottom: 15px;">Anteprima dei contatti da importare:</h4>
                ${importReady.slice(0, 10).map((client, index) => `
                    <div style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <strong>${index + 1}. ${client.name}</strong> 
                        <span style="background: ${client.type === 'prospect' ? '#f59e0b' : '#2563eb'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">${client.type}</span>
                        <div style="margin-top: 5px; font-size: 14px; color: #666;">
                            ${client.phone ? `📱 ${client.phone}` : ''}
                            ${client.email ? `📧 ${client.email}` : ''}
                            ${client.city ? `📍 ${client.city}` : ''}
                        </div>
                    </div>
                `).join('')}
                ${importReady.length > 10 ? `<p style="text-align: center; color: #666;">... e altri ${importReady.length - 10} contatti</p>` : ''}
            `;
            
            // Mostra riepilogo
            const existingCount = importReady.filter(newClient => 
                clients.some(existing => 
                    existing.name.toLowerCase() === newClient.name.toLowerCase() ||
                    (newClient.cf && existing.cf && existing.cf === newClient.cf)
                )
            ).length;
            
            summaryArea.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center;">
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--primary);">${importReady.length}</div>
                        <div style="color: #666;">Contatti da importare</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--secondary);">${importReady.length - existingCount}</div>
                        <div style="color: #666;">Nuovi contatti</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--warning);">${existingCount}</div>
                        <div style="color: #666;">Già esistenti (verranno saltati)</div>
                    </div>
                </div>
            `;
            
            // Salva per l'import finale
            window.quickImportReady = importReady;
        }

        function executeQuickImport() {
            const importReady = window.quickImportReady;
            if (!importReady || importReady.length === 0) {
                alert('Nessun dato da importare');
                return;
            }
            
            let imported = 0;
            let skipped = 0;
            
            importReady.forEach(newClient => {
                // Controlla duplicati
                const exists = clients.some(existing => 
                    existing.name.toLowerCase() === newClient.name.toLowerCase() ||
                    (newClient.cf && existing.cf && existing.cf === newClient.cf)
                );
                
                if (!exists) {
                    // Aggiungi nuovo cliente
                    const client = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        name: newClient.name,
                        phone: newClient.phone || '',
                        email: newClient.email || '',
                        cf: newClient.cf || '',
                        address: newClient.address || '',
                        civic: '',
                        city: newClient.city || '',
                        zip: newClient.zip || '',
                        province: newClient.province || '',
                        phoneFlow: '',
                        onlineServices: '',
                        myKey: 'NESSUN_MYKEY',
                        mifid: '',
                        type: newClient.type || 'cliente',
                        notes: newClient.notes || '',
                        createdAt: new Date().toISOString(),
                        products: [],
                        meetings: [],
                        documents: [],
                        familyMembers: []
                    };
                    
                    clients.push(client);
                    imported++;
                } else {
                    skipped++;
                }
            });
            
            // Salva e aggiorna
            saveData();
            renderLists();
            updateStats();
            closeQuickImportModal();
            
            // Mostra risultato
            showNotification(`✅ Import completato! ${imported} nuovi contatti aggiunti${skipped > 0 ? `, ${skipped} saltati` : ''}`);
        }

        // Compliance Alert Functions
        function openComplianceModal() {
            checkCompliance();
            document.getElementById('complianceModal').style.display = 'block';
        }

        function closeComplianceModal() {
            document.getElementById('complianceModal').style.display = 'none';
        }

        function updateComplianceBadge() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let urgentCount = 0;
            
            clients.forEach(client => {
                if (!client.compliance) return;
                
                // Controlla documento
                if (client.compliance.document && client.compliance.document.expiry) {
                    const expiry = new Date(client.compliance.document.expiry);
                    const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil < 30) urgentCount++;
                }
                
                // Controlla QAV
                if (client.compliance.qav && client.compliance.qav.expiry) {
                    const expiry = new Date(client.compliance.qav.expiry);
                    const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil < 30) urgentCount++;
                }
                
                // Controlla MIFID
                if (client.compliance.mifid && client.compliance.mifid.expiry) {
                    const expiry = new Date(client.compliance.mifid.expiry);
                    const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil < 30) urgentCount++;
                }
            });
            
            const badge = document.getElementById('complianceBadge');
            if (urgentCount > 0) {
                badge.style.display = 'flex';
                badge.textContent = urgentCount;
            } else {
                badge.style.display = 'none';
            }
        }

        function checkCompliance() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const expired = [];
            const expiring = [];
            const upcoming = [];
            
            clients.forEach(client => {
                if (!client.compliance) return;
                
                // Controlla documento
                if (client.compliance.document && client.compliance.document.expiry) {
                    const expiry = new Date(client.compliance.document.expiry);
                    const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    
                    const docTypeLabels = {
                        'carta_identita': 'Carta di Identità',
                        'carta_identita_elettronica': 'CIE',
                        'patente': 'Patente',
                        'passaporto': 'Passaporto'
                    };
                    
                    const item = {
                        client: client,
                        type: 'Documento - ' + (docTypeLabels[client.compliance.document.type] || 'Documento'),
                        expiry: expiry,
                        daysUntil: daysUntil
                    };
                    
                    if (daysUntil < 0) {
                        expired.push(item);
                    } else if (daysUntil <= 30) {
                        expiring.push(item);
                    } else if (daysUntil <= 90) {
                        upcoming.push(item);
                    }
                }
                
                // Controlla QAV
                if (client.compliance.qav && client.compliance.qav.expiry) {
                    const expiry = new Date(client.compliance.qav.expiry);
                    const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    
                    const item = {
                        client: client,
                        type: 'QAV',
                        expiry: expiry,
                        daysUntil: daysUntil
                    };
                    
                    if (daysUntil < 0) {
                        expired.push(item);
                    } else if (daysUntil <= 30) {
                        expiring.push(item);
                    } else if (daysUntil <= 90) {
                        upcoming.push(item);
                    }
                }
                
                // Controlla MIFID
                if (client.compliance.mifid && client.compliance.mifid.expiry) {
                    const expiry = new Date(client.compliance.mifid.expiry);
                    const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    
                    const item = {
                        client: client,
                        type: 'Profilo MIFID',
                        expiry: expiry,
                        daysUntil: daysUntil
                    };
                    
                    if (daysUntil < 0) {
                        expired.push(item);
                    } else if (daysUntil <= 30) {
                        expiring.push(item);
                    } else if (daysUntil <= 90) {
                        upcoming.push(item);
                    }
                }
            });
            
            // Ordina per urgenza
            expired.sort((a, b) => a.daysUntil - b.daysUntil);
            expiring.sort((a, b) => a.daysUntil - b.daysUntil);
            upcoming.sort((a, b) => a.daysUntil - b.daysUntil);
            
            displayCompliance(expired, expiring, upcoming);
        }

        function displayCompliance(expired, expiring, upcoming) {
            const expiredSection = document.getElementById('complianceExpiredSection');
            const expiringSection = document.getElementById('complianceExpiringSection');
            const upcomingSection = document.getElementById('complianceUpcomingSection');
            const noMessage = document.getElementById('noComplianceMessage');
            
            // Reset visibility
            expiredSection.style.display = 'none';
            expiringSection.style.display = 'none';
            upcomingSection.style.display = 'none';
            noMessage.style.display = 'none';
            
            let hasCompliance = false;
            
            // Scaduti
            if (expired.length > 0) {
                hasCompliance = true;
                expiredSection.style.display = 'block';
                document.getElementById('complianceExpired').innerHTML = expired.map(item => `
                    <div style="padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border: 2px solid #ef4444;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="font-size: 16px; color: #ef4444;">${item.client.name}</strong>
                                <div style="color: #666; margin-top: 5px;">
                                    <strong>${item.type}</strong> - Scaduto il ${item.expiry.toLocaleDateString('it-IT')}
                                    <span style="color: #ef4444; font-weight: bold;"> (${Math.abs(item.daysUntil)} giorni fa)</span>
                                </div>
                                ${item.client.phone ? `<div style="margin-top: 5px;">📱 ${item.client.phone}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary btn-small" onclick="showClientDetail('${item.client.id}')">
                                    Vai a Scheda
                                </button>
                                ${item.client.phone ? `
                                    <button class="btn btn-secondary btn-small" style="background: #25D366;" onclick="sendComplianceWhatsApp('${item.client.phone}', '${item.client.name}', '${item.type}')">
                                        WhatsApp
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // In scadenza
            if (expiring.length > 0) {
                hasCompliance = true;
                expiringSection.style.display = 'block';
                document.getElementById('complianceExpiring').innerHTML = expiring.map(item => `
                    <div style="padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${item.client.name}</strong>
                                <div style="color: #666; margin-top: 3px;">
                                    ${item.type} - Scade il ${item.expiry.toLocaleDateString('it-IT')}
                                    <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">
                                        ${item.daysUntil} ${item.daysUntil === 1 ? 'giorno' : 'giorni'}
                                    </span>
                                </div>
                            </div>
                            <button class="btn btn-primary btn-small" onclick="showClientDetail('${item.client.id}')">
                                Dettagli
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Prossime
            if (upcoming.length > 0) {
                hasCompliance = true;
                upcomingSection.style.display = 'block';
                document.getElementById('complianceUpcoming').innerHTML = upcoming.map(item => `
                    <div style="padding: 10px; background: white; border-radius: 6px; margin-bottom: 6px;">
                        <strong>${item.client.name}</strong> - ${item.type}
                        <span style="color: #666; margin-left: 10px;">
                            ${item.expiry.toLocaleDateString('it-IT')} (tra ${item.daysUntil} giorni)
                        </span>
                    </div>
                `).join('');
            }
            
            if (!hasCompliance) {
                noMessage.style.display = 'block';
            }
        }

        function sendComplianceWhatsApp(phone, name, docType) {
            const message = encodeURIComponent(`Gentile ${name}, le ricordiamo che il suo ${docType} risulta scaduto. La preghiamo di provvedere al rinnovo e di fornirci la documentazione aggiornata. Grazie.`);
            openWhatsApp(phone + '&text=' + message);
        }

        function toggleComplianceNotifications() {
            const enabled = document.getElementById('complianceNotifications').checked;
            localStorage.setItem('complianceNotificationsEnabled', enabled ? 'true' : 'false');
        }

        function checkComplianceOnStartup() {
            const enabled = localStorage.getItem('complianceNotificationsEnabled') === 'true';
            if (document.getElementById('complianceNotifications')) {
                document.getElementById('complianceNotifications').checked = enabled;
            }
            
            if (enabled) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let expiredCount = 0;
                let expiringCount = 0;
                
                clients.forEach(client => {
                    if (!client.compliance) return;
                    
                    // Lista di tutti i documenti da controllare
                    const checks = [
                        { data: client.compliance.document, name: 'Documento' },
                        { data: client.compliance.qav, name: 'QAV' },
                        { data: client.compliance.mifid, name: 'MIFID' }
                    ];
                    
                    checks.forEach(check => {
                        if (check.data && check.data.expiry) {
                            const expiry = new Date(check.data.expiry);
                            const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                            
                            if (daysUntil < 0) {
                                expiredCount++;
                            } else if (daysUntil <= 30) {
                                expiringCount++;
                            }
                        }
                    });
                });
                
                if (expiredCount > 0 || expiringCount > 0) {
                    setTimeout(() => {
                        let message = '📋 Promemoria Compliance:\n\n';
                        if (expiredCount > 0) {
                            message += `❌ ${expiredCount} ${expiredCount === 1 ? 'documento SCADUTO' : 'documenti SCADUTI'}!\n`;
                        }
                        if (expiringCount > 0) {
                            message += `⚠️ ${expiringCount} ${expiringCount === 1 ? 'documento' : 'documenti'} in scadenza nei prossimi 30 giorni\n`;
                        }
                        message += '\nVuoi vedere i dettagli?';
                        
                        if (confirm(message)) {
                            openComplianceModal();
                        }
                    }, 2000); // Mostra dopo i compleanni
                }
            }
        }

        function exportComplianceReport() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let csv = '\ufeff'; // UTF-8 BOM
            csv += 'Cliente,Telefono,Email,Tipo Documento,Stato,Data Scadenza,Giorni alla Scadenza\n';
            
            const reports = [];
            
            clients.forEach(client => {
                if (!client.compliance) return;
                
                // Documento
                if (client.compliance.document && client.compliance.document.expiry) {
                    const expiry = new Date(client.compliance.document.expiry);
                    const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    const stato = daysUntil < 0 ? 'SCADUTO' : daysUntil <= 30 ? 'IN SCADENZA' : 'VALIDO';
                    
                    reports.push({
                        name: client.name,
                        phone: client.phone || '',
                        email: client.email || '',
                        type: 'Documento - ' + client.compliance.document.type,
                        status: stato,
                        expiry: expiry.toLocaleDateString('it-IT'),
                        daysUntil: daysUntil
                    });
                }
                
                // QAV
                if (client.compliance.qav && client.compliance.qav.expiry) {
                    const expiry = new Date(client.compliance.qav.expiry);
                    const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    const stato = daysUntil < 0 ? 'SCADUTO' : daysUntil <= 30 ? 'IN SCADENZA' : 'VALIDO';
                    
                    reports.push({
                        name: client.name,
                        phone: client.phone || '',
                        email: client.email || '',
                        type: 'QAV',
                        status: stato,
                        expiry: expiry.toLocaleDateString('it-IT'),
                        daysUntil: daysUntil
                    });
                }
                
                // MIFID
                if (client.compliance.mifid && client.compliance.mifid.expiry) {
                    const expiry = new Date(client.compliance.mifid.expiry);
                    const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    const stato = daysUntil < 0 ? 'SCADUTO' : daysUntil <= 30 ? 'IN SCADENZA' : 'VALIDO';
                    
                    reports.push({
                        name: client.name,
                        phone: client.phone || '',
                        email: client.email || '',
                        type: 'Profilo MIFID',
                        status: stato,
                        expiry: expiry.toLocaleDateString('it-IT'),
                        daysUntil: daysUntil
                    });
                }
            });
            
            // Ordina per urgenza
            reports.sort((a, b) => a.daysUntil - b.daysUntil);
            
            // Genera CSV
            reports.forEach(r => {
                csv += `"${r.name}","${r.phone}","${r.email}","${r.type}","${r.status}","${r.expiry}","${r.daysUntil}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `report_compliance_${today.toISOString().split('T')[0]}.csv`;
            link.click();
            
            showNotification('Report compliance esportato!');
        }

        // Storage Status Check
        function checkStorageStatus() {
            try {
                const dataString = JSON.stringify(clients);
                const dataSize = new Blob([dataString]).size;
                const dataSizeMB = dataSize / (1024 * 1024);
                const percentage = (dataSizeMB / 10) * 100; // Su base 10MB
                
                // Mostra avviso nella sidebar solo se sopra il 70%
                if (percentage >= 70) {
                    const existingWarning = document.getElementById('storageWarningBadge');
                    if (!existingWarning) {
                        const backupBtn = document.querySelector('button[onclick="openBackupModal()"]');
                        if (backupBtn) {
                            const badge = document.createElement('span');
                            badge.id = 'storageWarningBadge';
                            badge.style.cssText = `
                                position: absolute; 
                                top: -5px; 
                                right: -5px; 
                                background: ${percentage >= 90 ? '#ef4444' : '#f59e0b'}; 
                                color: white; 
                                border-radius: 50%; 
                                width: 24px; 
                                height: 24px; 
                                font-size: 12px; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                font-weight: bold;
                            `;
                            badge.textContent = '!';
                            badge.title = `Storage ${Math.round(percentage)}% pieno`;
                            backupBtn.style.position = 'relative';
                            backupBtn.appendChild(badge);
                        }
                    }
                }
            } catch (error) {
                console.error('Errore controllo storage:', error);
            }
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>